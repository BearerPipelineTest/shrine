<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Extracting Metadata · Shrine</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Before a file is uploaded, Shrine automatically extracts metadata from it, and"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Extracting Metadata · Shrine"/><meta property="og:type" content="website"/><meta property="og:url" content="https://shrinerb.com/"/><meta property="og:description" content="Before a file is uploaded, Shrine automatically extracts metadata from it, and"/><meta property="og:image" content="https://shrinerb.com/img/logo.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://shrinerb.com/img/logo.png"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-149836844-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/js/version.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.png" alt="Shrine"/><h2 class="headerTitleWithLogo">Shrine</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/getting-started" target="_self">Guides</a></li><li class=""><a href="/docs/plugins/activerecord" target="_self">Plugins</a></li><li class=""><a href="/docs/external/extensions" target="_self">External</a></li><li class=""><a href="https://discourse.shrinerb.com" target="_blank">Discourse</a></li><li class=""><a href="https://github.com/shrinerb/shrine" target="_blank">GitHub</a></li><li class=""><a href="https://github.com/shrinerb/shrine/wiki" target="_blank">Wiki</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Features</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Introduction</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/advantages">Advantages of Shrine</a></li><li class="navListItem"><a class="navItem" href="/docs/getting-started">Getting Started</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Base</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/design">The Design of Shrine</a></li><li class="navListItem"><a class="navItem" href="/docs/retrieving-uploads">Retrieving Uploads</a></li><li class="navListItem"><a class="navItem" href="/docs/attacher">Using Attacher</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Storage</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/storage/file-system">File System</a></li><li class="navListItem"><a class="navItem" href="/docs/storage/s3">AWS S3</a></li><li class="navListItem"><a class="navItem" href="/docs/storage/memory">Memory</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Features</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/direct-s3">Direct Uploads to S3</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/metadata">Extracting Metadata</a></li><li class="navListItem"><a class="navItem" href="/docs/processing">File Processing</a></li><li class="navListItem"><a class="navItem" href="/docs/validation">File Validation</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Extras</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/multiple-files">Multiple Files</a></li><li class="navListItem"><a class="navItem" href="/docs/securing-uploads">Securing Uploads</a></li><li class="navListItem"><a class="navItem" href="/docs/testing">Testing with Shrine</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Migrating</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/changing-derivatives">Managing Derivatives</a></li><li class="navListItem"><a class="navItem" href="/docs/changing-location">Migrating File Locations</a></li><li class="navListItem"><a class="navItem" href="/docs/changing-storage">Migrating File Storage</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Extending</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/creating-plugins">Writing a Plugin</a></li><li class="navListItem"><a class="navItem" href="/docs/creating-persistence-plugins">Writing a Persistence Plugin</a></li><li class="navListItem"><a class="navItem" href="/docs/creating-storages">Writing a Storage</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Upgrading</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/upgrading-to-3">Upgrading to Shrine 3.x</a></li><li class="navListItem"><a class="navItem" href="/docs/carrierwave">Upgrading from CarrierWave</a></li><li class="navListItem"><a class="navItem" href="/docs/paperclip">Upgrading from Paperclip</a></li><li class="navListItem"><a class="navItem" href="/docs/refile">Upgrading from Refile</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/shrinerb/shrine/edit/master/doc/metadata.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 id="__docusaurus" class="postHeaderTitle">Extracting Metadata</h1></header><article><div><span><p>Before a file is uploaded, Shrine automatically extracts metadata from it, and
stores them in the <code>Shrine::UploadedFile</code> object.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;uploader<span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>file<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>metadata&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;{&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;size&quot;&nbsp;=&gt;&nbsp;345993,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;filename&quot;&nbsp;=&gt;&nbsp;&quot;matrix.mp4&quot;,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;mime_type&quot;&nbsp;=&gt;&nbsp;&quot;video/mp4&quot;,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;}&nbsp;</span></span></div></code></pre>
<p>Under the hood, <code>Shrine#upload</code> calls <code>Shrine#extract_metadata</code>, which you can
also use directly to extract metadata from any IO object:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploader<span class="punctuation separator method ruby">.</span>extract_metadata<span class="punctuation section function ruby">(</span>io<span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;{&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;size&quot;&nbsp;=&gt;&nbsp;345993,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;filename&quot;&nbsp;=&gt;&nbsp;&quot;matrix.mp4&quot;,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;mime_type&quot;&nbsp;=&gt;&nbsp;&quot;video/mp4&quot;,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;}&nbsp;</span></span></div></code></pre>
<p>The following metadata is extracted by default:</p>
<table>
<thead>
<tr><th style="text-align:left">Key</th><th style="text-align:left">Default source</th></tr>
</thead>
<tbody>
<tr><td style="text-align:left"><code>filename</code></td><td style="text-align:left">extracted from <code>io.original_filename</code> or <code>io.path</code></td></tr>
<tr><td style="text-align:left"><code>mime_type</code></td><td style="text-align:left">extracted from <code>io.content_type</code></td></tr>
<tr><td style="text-align:left"><code>size</code></td><td style="text-align:left">extracted from <code>io.size</code></td></tr>
</tbody>
</table>
<h2><a class="anchor" aria-hidden="true" id="accessing-metadata"></a><a href="#accessing-metadata" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Accessing metadata</h2>
<p>You can access the stored metadata in three ways:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;via&nbsp;methods&nbsp;(if&nbsp;they&#39;re&nbsp;defined)&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>size</span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>original_filename</span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>mime_type</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;via&nbsp;the&nbsp;metadata&nbsp;hash&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>metadata<span class="punctuation section array begin ruby">[</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>size<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section array end ruby">]</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>metadata<span class="punctuation section array begin ruby">[</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>filename<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section array end ruby">]</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>metadata<span class="punctuation section array begin ruby">[</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>mime_type<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section array end ruby">]</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;via&nbsp;the&nbsp;#[]&nbsp;operator&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation section array begin ruby">[</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>size<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section array end ruby">]</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation section array begin ruby">[</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>filename<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section array end ruby">]</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation section array begin ruby">[</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>mime_type<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section array end ruby">]</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="controlling-extraction"></a><a href="#controlling-extraction" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Controlling extraction</h2>
<p><code>Shrine#upload</code> accepts a <code>:metadata</code> option which accepts the following values:</p>
<ul>
<li><p><code>Hash</code> – adds/overrides extracted metadata with the given hash</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;uploader<span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>file<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">metadata<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>filename<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>Matrix[1999].mp4<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>foo<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>bar<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>original_filename&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;Matrix[1999].mp4&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>metadata<span class="punctuation section array begin ruby">[</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>foo<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section array end ruby">]</span>&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;bar&quot;&nbsp;</span></span></div></code></pre></li>
<li><p><code>false</code> – skips metadata extraction (useful in tests)</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;uploader<span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>file<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">metadata<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">false</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>metadata&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;{}&nbsp;</span></span></div></code></pre></li>
<li><p><code>true</code> – forces metadata extraction when a <code>Shrine::UploadedFile</code> is being
uploaded (by default metadata is simply copied over)</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;uploader<span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>uploaded_file<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">metadata<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>metadata&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;re-extracted&nbsp;metadata&nbsp;</span></span></div></code></pre></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="mime-type"></a><a href="#mime-type" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MIME type</h2>
<p>By default, the <code>mime_type</code> metadata will be copied over from the
<code>#content_type</code> attribute of the input file (if present). However, since
<code>#content_type</code> value comes from the <code>Content-Type</code> header of the upload
request, it's <em>not guaranteed</em> to hold the actual MIME type of the file (browser
determines this header based on file extension).</p>
<p>Moreover, only <code>ActionDispatch::Http::UploadedFile</code>, <code>Shrine::RackFile</code>, and
<code>Shrine::DataFile</code> objects have <code>#content_type</code> defined, so when uploading
objects such as <code>File</code>, the <code>mime_type</code> value will be nil by default.</p>
<p>To remedy that, Shrine comes with a
<a href="https://shrinerb.com/docs/plugins/determine_mime_type"><code>determine_mime_type</code></a> plugin which is able to extract
the MIME type from IO <em>content</em>:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;Gemfile&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>marcel<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>~&gt;&nbsp;0.3<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>determine_mime_type</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">analyzer<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>marcel</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;uploader<span class="punctuation separator method ruby">.</span>upload&nbsp;<span class="support class ruby">StringIO</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>&lt;?php&nbsp;...&nbsp;?&gt;<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>mime_type&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;application/x-php&quot;&nbsp;</span></span></div></code></pre>
<p>You can choose different analyzers, and even mix-and-match them. See the
<a href="https://shrinerb.com/docs/plugins/determine_mime_type"><code>determine_mime_type</code></a> plugin docs for more details.</p>
<h2><a class="anchor" aria-hidden="true" id="image-dimensions"></a><a href="#image-dimensions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Image Dimensions</h2>
<p>Shrine comes with a <a href="https://shrinerb.com/docs/plugins/store_dimensions"><code>store_dimensions</code></a> plugin for
extracting image dimensions. It adds <code>width</code> and <code>height</code> metadata values, and
also adds <code>#width</code>, <code>#height</code>, and <code>#dimensions</code> methods to the
<code>Shrine::UploadedFile</code> object.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;Gemfile&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>fastimage<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;default&nbsp;analyzer&nbsp;</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>store_dimensions</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;uploader<span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>image<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>metadata<span class="punctuation section array begin ruby">[</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>width<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section array end ruby">]</span>&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;1600&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>metadata<span class="punctuation section array begin ruby">[</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>height<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section array end ruby">]</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;900&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;convenience&nbsp;methods&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>width&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;1600&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>height&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;900&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>dimensions&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;[1600,&nbsp;900]&nbsp;</span></span></div></code></pre>
<p>By default, the plugin uses <a href="https://github.com/sdsykes/fastimage">FastImage</a> to analyze dimensions, but you can also
have it use <a href="https://github.com/minimagick/minimagick">MiniMagick</a> or <a href="https://github.com/libvips/ruby-vips">ruby-vips</a>. See the
<a href="https://shrinerb.com/docs/plugins/store_dimensions"><code>store_dimensions</code></a> plugin docs for more details.</p>
<h2><a class="anchor" aria-hidden="true" id="custom-metadata"></a><a href="#custom-metadata" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Custom metadata</h2>
<p>In addition to the built-in metadata, Shrine allows you to extract and store
any custom metadata, using the <a href="https://shrinerb.com/docs/plugins/add_metadata"><code>add_metadata</code></a> plugin (which
internally extends <code>Shrine#extract_metadata</code>).</p>
<p>For example, you might want to extract EXIF data from images:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;Gemfile&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>exiftool<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>exiftool<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">ImageUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>add_metadata</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;add_metadata&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>exif</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">io</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">context</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>with_file<span class="punctuation section function ruby">(</span>io<span class="punctuation section function ruby">)</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">file</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="support class ruby">Exiftool</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span>file<span class="punctuation separator method ruby">.</span>path<span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>to_hash</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;uploader<span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>image<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>metadata<span class="punctuation section array begin ruby">[</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>exif<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section array end ruby">]</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;{...}&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>exif&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;{...}&nbsp;</span></span></div></code></pre>
<p>Or, if you're uploading videos, you might want to extract some video-specific
metadata:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;Gemfile&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>streamio-ffmpeg<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>streamio-ffmpeg<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">VideoUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>add_metadata</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;add_metadata&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">io</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">context</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;movie&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>with_file<span class="punctuation section function ruby">(</span>io<span class="punctuation section function ruby">)</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">file</span><span class="punctuation separator variable ruby">|</span>&nbsp;<span class="support class ruby">FFMPEG</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Movie</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span>file<span class="punctuation separator method ruby">.</span>path<span class="punctuation section function ruby">)</span>&nbsp;<span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>duration<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;&nbsp;&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;movie<span class="punctuation separator method ruby">.</span>duration<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>bitrate<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;movie<span class="punctuation separator method ruby">.</span>bitrate<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>resolution<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;movie<span class="punctuation separator method ruby">.</span>resolution<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>frame_rate<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;movie<span class="punctuation separator method ruby">.</span>frame_rate&nbsp;<span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;uploader<span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>video<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>metadata&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;{&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;duration&quot;&nbsp;=&gt;&nbsp;7.5,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;bitrate&quot;&nbsp;=&gt;&nbsp;481,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;resolution&quot;&nbsp;=&gt;&nbsp;&quot;640x480&quot;,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;frame_rate&quot;&nbsp;=&gt;&nbsp;16.72&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;}&nbsp;</span></span></div></code></pre>
<p>The yielded <code>io</code> object will not always be an object that responds to <code>#path</code>.
For example, with the <code>data_uri</code> plugin the <code>io</code> can be a <code>StringIO</code> wrapper,
while with <code>restore_cached_data</code> or <code>refresh_metadata</code> plugins the <code>io</code> might
be a <code>Shrine::UploadedFile</code> object. So, we're using <code>Shrine.with_file</code> to
ensure we have a file object.</p>
<h3><a class="anchor" aria-hidden="true" id="adding-metadata"></a><a href="#adding-metadata" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Adding metadata</h3>
<p>If you wish to add metadata to an already attached file, you can do it as
follows:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image_attacher<span class="punctuation separator method ruby">.</span>add_metadata<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>foo<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>bar<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation separator method ruby">.</span>metadata&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;{&nbsp;...,&nbsp;&quot;foo&quot;&nbsp;=&gt;&nbsp;&quot;bar&quot;&nbsp;}&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>save&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;persist&nbsp;changes&nbsp;</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="metadata-columns"></a><a href="#metadata-columns" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Metadata columns</h2>
<p>If you want to write any of the metadata values into a separate database column
on the record, you can use the <code>metadata_attributes</code> plugin.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>metadata_attributes</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby"><span class="punctuation definition constant ruby">:</span>mime_type</span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>type</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Photo</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">image<span class="punctuation definition constant ruby">:</span></span>&nbsp;file<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image_type&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;image/jpeg&quot;&nbsp;</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="direct-uploads"></a><a href="#direct-uploads" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Direct uploads</h2>
<p>When attaching files that were uploaded directly to the cloud or a <a href="https://github.com/janko/tus-ruby-server">tus
server</a>, Shrine won't automatically extract metadata from them, instead it will
copy any existing metadata that was set on the client side. The reason why this
is the default behaviour is because metadata extraction requires (at least
partially) retrieving file content from the storage, which could potentially be
expensive depending on the storage and the type of metadata being extracted.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;no&nbsp;additional&nbsp;metadata&nbsp;will&nbsp;be&nbsp;extracted&nbsp;in&nbsp;this&nbsp;assignment&nbsp;by&nbsp;default&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="string quoted single ruby"><span class="punctuation definition string begin ruby">&#39;</span>{&quot;id&quot;:&quot;9e6581a4ea1.jpg&quot;,&quot;storage&quot;:&quot;cache&quot;,&quot;metadata&quot;:{...}}<span class="punctuation definition string end ruby">&#39;</span></span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="extracting-on-attachment"></a><a href="#extracting-on-attachment" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Extracting on attachment</h3>
<p>If you want metadata to be automatically extracted on assignment (which is
useful if you want to validate the extracted metadata or have it immediately
available for any other reason), you can load the <code>restore_cached_data</code> plugin:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>restore_cached_data</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;automatically&nbsp;extract&nbsp;metadata&nbsp;from&nbsp;cached&nbsp;files&nbsp;on&nbsp;assignment&nbsp;</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="string quoted single ruby"><span class="punctuation definition string begin ruby">&#39;</span>{&quot;id&quot;:&quot;ks9elsd.jpg&quot;,&quot;storage&quot;:&quot;cache&quot;,&quot;metadata&quot;:{}}<span class="punctuation definition string end ruby">&#39;</span></span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;metadata&nbsp;is&nbsp;extracted&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation separator method ruby">.</span>metadata&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;{&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;size&quot;&nbsp;=&gt;&nbsp;4593484,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;filename&quot;&nbsp;=&gt;&nbsp;&quot;nature.jpg&quot;,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;mime_type&quot;&nbsp;=&gt;&nbsp;&quot;image/jpeg&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;}&nbsp;</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="extracting-in-the-background"></a><a href="#extracting-in-the-background" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Extracting in the background</h3>
<h4><a class="anchor" aria-hidden="true" id="a-extracting-with-promotion"></a><a href="#a-extracting-with-promotion" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A) Extracting with promotion</h4>
<p>If you're using <a href="https://shrinerb.com/docs/plugins/backgrounding">backgrounding</a>, you can extract metadata during background
promotion using the <code>refresh_metadata</code> plugin (which the <code>restore_cached_data</code>
plugin uses internally):</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>refresh_metadata</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;allow&nbsp;re-extracting&nbsp;metadata&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>backgrounding</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>promote_block&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">PromoteJob</span><span class="punctuation separator method ruby">.</span>perform_async<span class="punctuation section function ruby">(</span><span class="variable language self ruby">self</span><span class="punctuation separator method ruby">.</span>class<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span>&nbsp;record<span class="punctuation separator method ruby">.</span>class<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span>&nbsp;record<span class="punctuation separator method ruby">.</span>id<span class="punctuation separator object ruby">,</span>&nbsp;name<span class="punctuation separator object ruby">,</span>&nbsp;file_data<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">PromoteJob</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">include</span>&nbsp;<span class="support class ruby">Sidekiq</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Worker</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">perform</span><span class="punctuation definition parameters ruby">(</span><span class="variable parameter function ruby">attacher_class</span>,&nbsp;<span class="variable parameter function ruby">record_class</span>,&nbsp;<span class="variable parameter function ruby">record_id</span>,&nbsp;<span class="variable parameter function ruby">name</span>,&nbsp;<span class="variable parameter function ruby">file_data</span><span class="punctuation definition parameters ruby">)</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher_class&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>attacher_class<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;record&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>record_class<span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>find<span class="punctuation section function ruby">(</span>record_id<span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;if&nbsp;using&nbsp;Active&nbsp;Record&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher_class<span class="punctuation separator method ruby">.</span>retrieve<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">model<span class="punctuation definition constant ruby">:</span></span>&nbsp;record<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">name<span class="punctuation definition constant ruby">:</span></span>&nbsp;name<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">file<span class="punctuation definition constant ruby">:</span></span>&nbsp;file_data<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>refresh_metadata!&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;extract&nbsp;metadata&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>atomic_promote</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<h4><a class="anchor" aria-hidden="true" id="b-extracting-separately-from-promotion"></a><a href="#b-extracting-separately-from-promotion" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>B) Extracting separately from promotion</h4>
<p>You can also extract metadata in the background separately from promotion:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">MetadataJob</span><span class="punctuation separator method ruby">.</span>perform_async<span class="punctuation section function ruby">(</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>class<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>record<span class="punctuation separator method ruby">.</span>class<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>record<span class="punctuation separator method ruby">.</span>id<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>file_data<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section function ruby">)</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">MetadataJob</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">include</span>&nbsp;<span class="support class ruby">Sidekiq</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Worker</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">perform</span><span class="punctuation definition parameters ruby">(</span><span class="variable parameter function ruby">attacher_class</span>,&nbsp;<span class="variable parameter function ruby">record_class</span>,&nbsp;<span class="variable parameter function ruby">record_id</span>,&nbsp;<span class="variable parameter function ruby">name</span>,&nbsp;<span class="variable parameter function ruby">file_data</span><span class="punctuation definition parameters ruby">)</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher_class&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>attacher_class<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;record&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>record_class<span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>find<span class="punctuation section function ruby">(</span>record_id<span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;if&nbsp;using&nbsp;Active&nbsp;Record&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher_class<span class="punctuation separator method ruby">.</span>retrieve<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">model<span class="punctuation definition constant ruby">:</span></span>&nbsp;record<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">name<span class="punctuation definition constant ruby">:</span></span>&nbsp;name<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">file<span class="punctuation definition constant ruby">:</span></span>&nbsp;file_data<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>refresh_metadata!</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>atomic_persist</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="combining-foreground-and-background"></a><a href="#combining-foreground-and-background" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Combining foreground and background</h3>
<p>If you have some metadata that you want to extract in the foreground and some
that you want to extract in the background, you can use the uploader context:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">VideoUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>add_metadata</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;add_metadata&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">io</span><span class="punctuation separator variable ruby">,</span>&nbsp;**<span class="variable other block ruby">options</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword control pseudo-method ruby">next</span>&nbsp;<span class="keyword control ruby">unless</span>&nbsp;options<span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>background</span><span class="punctuation section array end ruby">]</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;proceed&nbsp;only&nbsp;when&nbsp;`background:&nbsp;true`&nbsp;was&nbsp;specified&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;example&nbsp;of&nbsp;metadata&nbsp;extraction&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;movie&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>with_file<span class="punctuation section function ruby">(</span>io<span class="punctuation section function ruby">)</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">file</span><span class="punctuation separator variable ruby">|</span>&nbsp;<span class="support class ruby">FFMPEG</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Movie</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span>file<span class="punctuation separator method ruby">.</span>path<span class="punctuation section function ruby">)</span>&nbsp;<span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>duration<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;&nbsp;&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;movie<span class="punctuation separator method ruby">.</span>duration<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>bitrate<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;movie<span class="punctuation separator method ruby">.</span>bitrate<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>resolution<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;movie<span class="punctuation separator method ruby">.</span>resolution<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>frame_rate<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;movie<span class="punctuation separator method ruby">.</span>frame_rate&nbsp;<span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">PromoteJob</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">include</span>&nbsp;<span class="support class ruby">Sidekiq</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Worker</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">perform</span><span class="punctuation definition parameters ruby">(</span><span class="variable parameter function ruby">attacher_class</span>,&nbsp;<span class="variable parameter function ruby">record_class</span>,&nbsp;<span class="variable parameter function ruby">record_id</span>,&nbsp;<span class="variable parameter function ruby">name</span>,&nbsp;<span class="variable parameter function ruby">file_data</span><span class="punctuation definition parameters ruby">)</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher_class&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>attacher_class<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;record&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>record_class<span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>find<span class="punctuation section function ruby">(</span>record_id<span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;if&nbsp;using&nbsp;Active&nbsp;Record&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher_class<span class="punctuation separator method ruby">.</span>retrieve<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">model<span class="punctuation definition constant ruby">:</span></span>&nbsp;record<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">name<span class="punctuation definition constant ruby">:</span></span>&nbsp;name<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">file<span class="punctuation definition constant ruby">:</span></span>&nbsp;file_data<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>refresh_metadata!<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">background<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;specify&nbsp;the&nbsp;flag&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>atomic_promote</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>Now triggering metadata extraction in the controller on attachment (using
<code>restore_cached_data</code> or <code>refresh_metadata</code> plugin) will skip the video
metadata block, which will be triggered later in the background job.</p>
<h3><a class="anchor" aria-hidden="true" id="optimizations"></a><a href="#optimizations" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Optimizations</h3>
<p>If you want to do both metadata extraction and file processing during
promotion, you can wrap both in an <code>UploadedFile#open</code> block to make
sure the file content is retrieved from the storage only once.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">PromoteJob</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">include</span>&nbsp;<span class="support class ruby">Sidekiq</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Worker</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">perform</span><span class="punctuation definition parameters ruby">(</span><span class="variable parameter function ruby">attacher_class</span>,&nbsp;<span class="variable parameter function ruby">record_class</span>,&nbsp;<span class="variable parameter function ruby">record_id</span>,&nbsp;<span class="variable parameter function ruby">name</span>,&nbsp;<span class="variable parameter function ruby">file_data</span><span class="punctuation definition parameters ruby">)</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher_class&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>attacher_class<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;record&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>record_class<span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>find<span class="punctuation section function ruby">(</span>record_id<span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;if&nbsp;using&nbsp;Active&nbsp;Record&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher_class<span class="punctuation separator method ruby">.</span>retrieve<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">model<span class="punctuation definition constant ruby">:</span></span>&nbsp;record<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">name<span class="punctuation definition constant ruby">:</span></span>&nbsp;name<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">file<span class="punctuation definition constant ruby">:</span></span>&nbsp;file_data<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>file<span class="punctuation separator method ruby">.</span><span class="support function kernel ruby">open</span>&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>refresh_metadata!</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>create_derivatives</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>atomic_promote</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>If you're dealing with large files and have metadata extractors that use
<code>Shrine.with_file</code>, you might want to use the <code>tempfile</code> plugin to make sure
the same copy of the uploaded file is reused for both metadata extraction and
file processing.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>tempfile</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;load&nbsp;it&nbsp;globally&nbsp;so&nbsp;that&nbsp;it&nbsp;overrides&nbsp;`Shrine.with_file`&nbsp;</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>file<span class="punctuation separator method ruby">.</span><span class="support function kernel ruby">open</span>&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>refresh_metadata!</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>create_derivatives<span class="punctuation section function ruby">(</span>attacher<span class="punctuation separator method ruby">.</span>file<span class="punctuation separator method ruby">.</span>tempfile<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div></code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/direct-s3"><span class="arrow-prev">← </span><span>Direct Uploads to S3</span></a><a class="docs-next button" href="/docs/processing"><span>File Processing</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#accessing-metadata">Accessing metadata</a></li><li><a href="#controlling-extraction">Controlling extraction</a></li><li><a href="#mime-type">MIME type</a></li><li><a href="#image-dimensions">Image Dimensions</a></li><li><a href="#custom-metadata">Custom metadata</a><ul class="toc-headings"><li><a href="#adding-metadata">Adding metadata</a></li></ul></li><li><a href="#metadata-columns">Metadata columns</a></li><li><a href="#direct-uploads">Direct uploads</a><ul class="toc-headings"><li><a href="#extracting-on-attachment">Extracting on attachment</a></li><li><a href="#extracting-in-the-background">Extracting in the background</a></li><li><a href="#combining-foreground-and-background">Combining foreground and background</a></li><li><a href="#optimizations">Optimizations</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer" data-version="3.4.0"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/logo.png" alt="Shrine" width="66"/></a><div><h5>Docs</h5><a href="/guides">Guides</a><a href="/plugins">Plugins</a><a href="/external">External</a><a href="https://github.com/shrinerb/shrine/blob/master/CONTRIBUTING.md#readme">Contributing</a></div><div><h5>Community</h5><a href="https://discourse.shrinerb.com" target="_blank" rel="noreferrer noopener">Discourse</a><a href="https://stackoverflow.com/questions/tagged/shrine" target="_blank" rel="noreferrer noopener">Stack Overflow</a></div><div><h5>More</h5><a href="https://twin.github.io">Blog</a><a href="https://github.com/shrinerb/shrine">GitHub</a><a class="github-button" href="https://github.com/shrinerb/shrine" data-icon="octicon-star" data-count-href="/shrinerb/shrine/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a><div class="social"><a href="https://twitter.com/shrine_rb" class="twitter-follow-button">Follow @shrine_rb</a></div></div></section><section class="copyright">Copyright © 2022 Janko Marohnić</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '09a11b10801874df7d226df4f2ce8e8f',
                indexName: 'shrinerb',
                inputSelector: '#search_input_react'
              });
            </script></body></html>