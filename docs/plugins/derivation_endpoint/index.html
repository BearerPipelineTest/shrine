<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Derivation Endpoint · Shrine</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="The [`derivation_endpoint`][derivation_endpoint] plugin provides a Rack app for"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Derivation Endpoint · Shrine"/><meta property="og:type" content="website"/><meta property="og:url" content="https://shrinerb.com/"/><meta property="og:description" content="The [`derivation_endpoint`][derivation_endpoint] plugin provides a Rack app for"/><meta property="og:image" content="https://shrinerb.com/img/logo.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://shrinerb.com/img/logo.png"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-149836844-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/js/version.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.png" alt="Shrine"/><h2 class="headerTitleWithLogo">Shrine</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/getting-started" target="_self">Guides</a></li><li class="siteNavGroupActive"><a href="/docs/plugins/activerecord" target="_self">Plugins</a></li><li class=""><a href="/docs/external/extensions" target="_self">External</a></li><li class=""><a href="https://discourse.shrinerb.com" target="_blank">Discourse</a></li><li class=""><a href="https://github.com/shrinerb/shrine" target="_blank">GitHub</a></li><li class=""><a href="https://github.com/shrinerb/shrine/wiki" target="_blank">Wiki</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Processing</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Attachment</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/activerecord">Active Record</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/column">Column</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/entity">Entity</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/model">Model</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/sequel">Sequel</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Flow</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/backgrounding">Backgrounding</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/presign_endpoint">Presign Endpoint</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/upload_endpoint">Upload Endpoint</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Processing</h3><ul class=""><li class="navListItem navListItemActive"><a class="navItem" href="/docs/plugins/derivation_endpoint">Derivation Endpoint</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/derivatives">Derivatives</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Source</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/data_uri">Data URI</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/rack_file">Rack File</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/remote_url">Remote URL</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Validation</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/remove_invalid">Remove Invalid</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/validation">Validation</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/validation_helpers">Validation Helpers</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Metadata</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/add_metadata">Add Metadata</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/determine_mime_type">Determine MIME Type</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/infer_extension">Infer Extension</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/metadata_attributes">Metadata Attributes</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/refresh_metadata">Refresh Metadata</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/restore_cached_data">Restore Cached Data</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/signature">Signature</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/store_dimensions">Store Dimensions</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/type_predicates">Type Predicates</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Downloading</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/download_endpoint">Download Endpoint</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/rack_response">Rack Response</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/tempfile">Tempfile</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Form</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/cached_attachment_data">Cached Attachment Data</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/form_assign">Form Assign</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/remove_attachment">Remove Attachment</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Settings</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/default_storage">Default Storage</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/default_url">Default URL</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/dynamic_storage">Dynamic Storage</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/multi_cache">Multi Cache</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/pretty_location">Pretty Location</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/upload_options">Upload Options</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/url_options">URL Options</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Other</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/atomic_helpers">Atomic Helpers</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/included">Included</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/instrumentation">Instrumentation</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/keep_files">Keep Files</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/mirroring">Mirroring</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/shrinerb/shrine/edit/master/doc/plugins/derivation_endpoint.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 id="__docusaurus" class="postHeaderTitle">Derivation Endpoint</h1></header><article><div><span><p>The <a href="https://github.com/shrinerb/shrine/blob/master/lib/shrine/plugins/derivation_endpoint.rb"><code>derivation_endpoint</code></a> plugin provides a Rack app for
dynamically processing uploaded files on request. This allows you to create
URLs to files that might not have been generated yet, and have the endpoint
process them on-the-fly.</p>
<h2><a class="anchor" aria-hidden="true" id="quick-start"></a><a href="#quick-start" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Quick start</h2>
<p>We first load the plugin, providing a secret key and a path prefix to where the
endpoint will be mounted:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">ImageUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">secret_key<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>&lt;YOUR&nbsp;SECRET&nbsp;KEY&gt;<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">prefix<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>derivations/image<span class="punctuation definition string end ruby">&quot;</span></span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>We can then mount the derivation endpoint for our uploader into our app's
router on the path prefix we specified:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;config/routes.rb&nbsp;(Rails)&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Rails</span><span class="punctuation separator method ruby">.</span>application<span class="punctuation separator method ruby">.</span>routes<span class="punctuation separator method ruby">.</span>draw&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;mount&nbsp;<span class="support class ruby">ImageUploader</span><span class="punctuation separator method ruby">.</span>derivation_endpoint&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>derivations/image<span class="punctuation definition string end ruby">&quot;</span></span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>Next we can define a &quot;derivation&quot; block for the type of processing we want to
apply to an attached file. For example, we can generate image thumbnails using
the <a href="https://github.com/janko/image_processing">ImageProcessing</a> gem:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image_processing<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>~&gt;&nbsp;1.8<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image_processing/mini_magick<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">ImageUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;derivation&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">file</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">width</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">height</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="support class ruby">ImageProcessing</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">MiniMagick</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>source<span class="punctuation section function ruby">(</span>file<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>resize_to_limit!<span class="punctuation section function ruby">(</span>width<span class="punctuation separator method ruby">.</span>to_i<span class="punctuation separator object ruby">,</span>&nbsp;height<span class="punctuation separator method ruby">.</span>to_i<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>Now we can generate &quot;derivation&quot; URLs from attached files, which on request
will call the derivation block we defined.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation separator method ruby">.</span>derivation_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">600</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">400</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;/derivations/image/thumbnail/600/400/eyJpZCI6ImZvbyIsInN0b3JhZ2UiOiJzdG9yZSJ9?signature=...&quot;&nbsp;</span></span></div></code></pre>
<p>In this example, <code>photo</code> is an instance of a <code>Photo</code> model which has an <code>image</code>
attachment. The URL will render a <code>600x400</code> thumbnail of the original image.</p>
<h2><a class="anchor" aria-hidden="true" id="how-it-works"></a><a href="#how-it-works" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How it works</h2>
<p>The <code>#derivation_url</code> method is defined on <code>Shrine::UploadedFile</code> objects. It
generates an URL consisting of the configured <a href="#prefix">path prefix</a>,
derivation name and arguments, serialized uploaded file, and an URL signature
generated using the configured secret key:</p>
<pre><code class="hljs">/  derivations/image  /  thumbnail  /  600/400  /  eyJmZvbyIb3JhZ2UiOiJzdG9yZSJ9  ?  signature=...
  └──── prefix ─────┘  └── name ──┘  └─ args ─┘  └─── serialized source file ───┘
</code></pre>
<p>When the derivation URL is requested, the derivation endpoint will first verify
the signature included in query params, and proceed only if it matches the
calculated signature. This ensures that only the server can generate valid
derivation URLs, preventing potential DoS attacks.</p>
<p>The derivation endpoint then extracts the source file data, derivation name and
arguments from the request URL, and calls the corresponding derivation block,
passing the downloaded source file and derivation arguments. The derivation
block is evaluated within the context of a
<a href="#derivation-api"><code>Shrine::Derivation</code></a> instance.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">derivation&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">file</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">arg1</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">arg2</span><span class="punctuation separator variable ruby">,</span>&nbsp;...<span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="variable language self ruby">self</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::Derivation&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;file&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Tempfile:...&gt;&nbsp;(source&nbsp;file&nbsp;downloaded&nbsp;to&nbsp;disk)&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;arg1&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;600&quot;&nbsp;(first&nbsp;derivation&nbsp;argument&nbsp;in&nbsp;#derivation_url)&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;arg2&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;400&quot;&nbsp;(second&nbsp;derivation&nbsp;argument&nbsp;in&nbsp;#derivation_url)&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;do&nbsp;processing&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;return&nbsp;result&nbsp;as&nbsp;a&nbsp;File&nbsp;or&nbsp;Tempfile&nbsp;object&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>The derivation block is expected to return the processed file as a <code>File</code> or
<code>Tempfile</code> object. The resulting file is then rendered in the HTTP response.</p>
<h3><a class="anchor" aria-hidden="true" id="performance"></a><a href="#performance" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Performance</h3>
<p>By default, the processed file returned by the derivation block is not cached
anywhere. This means that repeated requests to the same derivation URL will
execute the derivation block each time, which can put a lot of load on your
application.</p>
<p>For this reason it's highly recommended to put a <strong>CDN or other HTTP cache</strong> in
front of your application. If you've configured a CDN, you can set the CDN host
at the plugin level, and it will be used for all derivation URLs:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">host<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span><span class="markup underline link https hyperlink">https://your-dist-url.cloudfront.net</span><span class="punctuation definition string end ruby">&quot;</span></span></span></div></code></pre>
<p>Additionally, you can have the endpoint cache derivatives to a storage. With
this setup, the generated derivative will be uploaded to the storage on initial
request, and then on subsequent requests the derivative will be served directly
from the storage.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">upload<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span></span></div></code></pre>
<p>If you want to avoid having the endpoint directly serve the generated
derivatives, you can have the derivation response redirect to the uploaded
derivative on the storage service.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">upload<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">upload_redirect<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span></span></div></code></pre>
<p>For more details, see the <a href="#uploading">Uploading</a> section.</p>
<h2><a class="anchor" aria-hidden="true" id="derivation-response"></a><a href="#derivation-response" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Derivation response</h2>
<p>Mounting the derivation endpoint into the app's router is the easiest way to
handle derivation requests, as routing and setting the response is done
automatically.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;config/routes.rb&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Rails</span><span class="punctuation separator method ruby">.</span>application<span class="punctuation separator method ruby">.</span>routes<span class="punctuation separator method ruby">.</span>draw&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;mount&nbsp;<span class="support class ruby">ImageUploader</span><span class="punctuation separator method ruby">.</span>derivation_endpoint&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>derivations/image<span class="punctuation definition string end ruby">&quot;</span></span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>However, this approach can also be limiting if one wants to perform additional
operations around derivation requests, such as authentication and
authorization.</p>
<p>Instead of mounting the endpoint into the router, you can also call the
derivation endpoint from a controller. In this case the endpoint needs to
receive the Rack env hash, so that it can infer derivation parameters from the
request URL. The return value is a 3-element array, containing the status,
headers, and body that should be returned in the HTTP response:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;config/routes.rb&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Rails</span><span class="punctuation separator method ruby">.</span>application<span class="punctuation separator method ruby">.</span>routes<span class="punctuation separator method ruby">.</span>draw&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;get&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>/derivations/image/*rest<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>derivations#image<span class="punctuation definition string end ruby">&quot;</span></span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;app/controllers/derivations_controller.rb&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">DerivationsController<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;ApplicationController</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method without-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">image</span></span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;we&nbsp;can&nbsp;perform&nbsp;authentication&nbsp;here&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;set_rack_response&nbsp;<span class="support class ruby">ImageUploader</span><span class="punctuation separator method ruby">.</span>derivation_response<span class="punctuation section function ruby">(</span>request<span class="punctuation separator method ruby">.</span>env<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">private</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">set_rack_response</span><span class="punctuation definition parameters ruby">(</span><span class="punctuation section function ruby">(</span>status,&nbsp;<span class="variable parameter function ruby">headers</span>,&nbsp;<span class="variable parameter function ruby">body</span><span class="punctuation definition parameters ruby">)</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable language self ruby">self</span><span class="punctuation separator method ruby">.</span>status&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;status</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable language self ruby">self</span><span class="punctuation separator method ruby">.</span>headers<span class="punctuation separator method ruby">.</span>merge!<span class="punctuation section function ruby">(</span>headers<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable language self ruby">self</span><span class="punctuation separator method ruby">.</span>response_body&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;body</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>For even more control, you can generate derivation responses in custom routes.
Once you retrieve the <code>Shrine::UploadedFile</code> object, you can call
<code>#derivation_response</code> directly on it, passing the derivation name and
arguments, as well as the Rack env hash.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;config/routes.rb&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Rails</span><span class="punctuation separator method ruby">.</span>application<span class="punctuation separator method ruby">.</span>routes<span class="punctuation separator method ruby">.</span>draw&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;resources&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>photos</span>&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;member&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>thumbnail<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;for&nbsp;example&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;app/controllers/photos_controller.rb&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">PhotosController<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;ApplicationController</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method without-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">thumbnail</span></span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;we&nbsp;can&nbsp;perform&nbsp;authorization&nbsp;here&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;photo&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Photo</span><span class="punctuation separator method ruby">.</span>find<span class="punctuation section function ruby">(</span>params<span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>id</span><span class="punctuation section array end ruby">]</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;image&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;photo<span class="punctuation separator method ruby">.</span>image</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;set_rack_response&nbsp;image<span class="punctuation separator method ruby">.</span>derivation_response<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">300</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">300</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">env<span class="punctuation definition constant ruby">:</span></span>&nbsp;request<span class="punctuation separator method ruby">.</span>env<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">private</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">set_rack_response</span><span class="punctuation definition parameters ruby">(</span><span class="punctuation section function ruby">(</span>status,&nbsp;<span class="variable parameter function ruby">headers</span>,&nbsp;<span class="variable parameter function ruby">body</span><span class="punctuation definition parameters ruby">)</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable language self ruby">self</span><span class="punctuation separator method ruby">.</span>status&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;status</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable language self ruby">self</span><span class="punctuation separator method ruby">.</span>headers<span class="punctuation separator method ruby">.</span>merge!<span class="punctuation section function ruby">(</span>headers<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable language self ruby">self</span><span class="punctuation separator method ruby">.</span>response_body&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;body</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p><code>Shrine.derivation_endpoint</code>, <code>Shrine.derivation_response</code>, and
<code>UploadedFile#derivation_response</code> methods all accept additional options, which
will override options set on the plugin level.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">ImageUploader</span><span class="punctuation separator method ruby">.</span>derivation_endpoint<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">disposition<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>attachment<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;or&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">ImageUploader</span><span class="punctuation separator method ruby">.</span>derivation_response<span class="punctuation section function ruby">(</span>env<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">disposition<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>attachment<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;or&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>derivation_response<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">env<span class="punctuation definition constant ruby">:</span></span>&nbsp;env<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">disposition<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>attachment<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="dynamic-settings"></a><a href="#dynamic-settings" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dynamic settings</h2>
<p>For most options passed to <code>plugin :derivation_endpoint</code>,
<code>Shrine.derivation_endpoint</code>, <code>Shrine.derivation_response</code>, or
<code>Shrine::UploadedFile#derivation_response</code>, the value can also be a block that
returns a dynamic result. The block will be evaluated within the context of a
<a href="#derivation-api"><code>Shrine::Derivation</code></a> instance, allowing you to access
information about the current derivation:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">disposition<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="variable language self ruby">self</span>&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::Derivation&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;name&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;:thumbnail&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;args&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;[&quot;500&quot;,&nbsp;&quot;400&quot;]&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;source&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section scope end ruby">}</span></span></div></code></pre>
<p>For example, we can use it to specify that thumbnails should be rendered inline
in the browser, while other derivatives will be force downloaded.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">disposition<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;name&nbsp;<span class="keyword operator comparison ruby">==</span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span>&nbsp;<span class="keyword operator comparison ruby">?</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>inline<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation separator other ruby">:</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>attachment<span class="punctuation definition string end ruby">&quot;</span></span></span></div><div class="line"><span class="source ruby"><span class="punctuation section scope end ruby">}</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="host"></a><a href="#host" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Host</h2>
<p>Derivation URLs are relative by default. To generate absolute URLs, you can
pass the <code>:host</code> option:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">host<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span><span class="markup underline link https hyperlink">https://example.com</span><span class="punctuation definition string end ruby">&quot;</span></span></span></div></code></pre>
<p>Now the generated URLs will include the specified URL host:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>derivation_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;<span class="markup underline link https hyperlink">https://example.com/.../thumbnail/eyJpZCI6ImZvbyIsInN?signature=</span>...&quot;&nbsp;</span></span></div></code></pre>
<p>You can also pass <code>:host</code> per URL:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>derivation_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">host<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span><span class="markup underline link https hyperlink">https://example.com</span><span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;<span class="markup underline link https hyperlink">https://example.com/.../thumbnail/eyJpZCI6ImZvbyIsInN?signature=</span>...&quot;&nbsp;</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="prefix"></a><a href="#prefix" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Prefix</h2>
<p>If you're mounting the derivation endpoint under a path prefix, the derivation
URLs will need to include that path prefix. This can be configured with the
<code>:prefix</code> option:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">prefix<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>transformations/image<span class="punctuation definition string end ruby">&quot;</span></span></span></div></code></pre>
<p>Now generated URLs will include the specified path prefix:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>derivation_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;.../transformations/image/thumbnail/eyJpZCI6ImZvbyIsInN?signature=...&quot;&nbsp;</span></span></div></code></pre>
<p>You can also pass <code>:prefix</code> per URL:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>derivation_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">prefix<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>transformations/image<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;.../transformations/image/thumbnail/eyJpZCI6ImZvbyIsInN?signature=...&quot;&nbsp;</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="expiration"></a><a href="#expiration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Expiration</h2>
<p>By default derivation URLs are valid indefinitely. If you want URLs to expire
after a certain amount of time, you can set the <code>:expires_in</code> option:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">expires_in<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant numeric ruby">90</span></span></div></code></pre>
<p>Now any URL will stop being valid 90 seconds after it was generated:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>derivation_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;.../thumbnail/eyJpZCI6ImZvbyIsInN?expires_at=1547843568&amp;signature=...&quot;&nbsp;</span></span></div></code></pre>
<p>You can also pass <code>:expires_in</code> per URL:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>derivation_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">expires_in<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant numeric ruby">90</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;.../thumbnail/eyJpZCI6ImZvbyIsInN?expires_at=1547843568&amp;signature=...&quot;&nbsp;</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="response-headers"></a><a href="#response-headers" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Response headers</h2>
<h3><a class="anchor" aria-hidden="true" id="content-type"></a><a href="#content-type" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Content Type</h3>
<p>The derivation response includes the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type"><code>Content-Type</code></a> header. By default
default its value will be inferred from the file extension of the generated
derivative (using <code>Rack::Mime</code>). This can be overriden with the <code>:type</code> option:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">type<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image/webp<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="keyword control ruby">if</span>&nbsp;name&nbsp;<span class="keyword operator comparison ruby">==</span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>webp</span>&nbsp;<span class="punctuation section scope end ruby">}</span></span></div></code></pre>
<p>The above will set <code>Content-Type</code> response header value to <code>image/webp</code> for
<code>:webp</code> derivatives, while for others it will be inferred from the file
extension if possible.</p>
<p>You can also set <code>:type</code> per URL:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>derivation_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>webp</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">type<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image/webp<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;.../webp/eyJpZCI6ImZvbyIsInN?type=image%2Fwebp&amp;signature=...&quot;&nbsp;</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="content-disposition"></a><a href="#content-disposition" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Content Disposition</h3>
<p>The derivation response includes the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Disposition"><code>Content-Disposition</code></a> header. By default
the disposition is set to <code>inline</code>, with download filename generated from
derivation name, arguments and source file id. These values can be changed with
the <code>:disposition</code> and <code>:filename</code> options:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">disposition<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span>name&nbsp;<span class="keyword operator comparison ruby">==</span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span>&nbsp;<span class="keyword operator comparison ruby">?</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>inline<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation separator other ruby">:</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>attachment<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">filename<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="punctuation section array begin ruby">[</span>name<span class="punctuation separator object ruby">,</span>&nbsp;<span class="keyword operator arithmetic ruby">*</span>args<span class="punctuation section array end ruby">]</span><span class="punctuation separator method ruby">.</span>join<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>-<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span>&nbsp;<span class="punctuation section scope end ruby">}</span></span></div></code></pre>
<p>With the above settings, visiting a thumbnail URL will render the image in the
browser, while other derivatives will be treated as an attachment and be
downloaded.</p>
<p>The <code>:filename</code> and <code>:disposition</code> options can also be set per URL:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>derivation_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>pdf</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">disposition<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>attachment<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">filename<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>custom-filename<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;.../thumbnail/eyJpZCI6ImZvbyIsInN?disposition=attachment&amp;filename=custom-filename&amp;signature=...&quot;&nbsp;</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="cache-control"></a><a href="#cache-control" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cache Control</h3>
<p>The endpoint uses the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control"><code>Cache-Control</code></a> response header to tell clients
(browsers, CDNs, HTTP caches) how long they can cache derivation responses. The
default cache duration is 1 year from the initial request, or if
<a href="#expiration"><code>:expires_in</code></a> is used it's the time until the URL expires. The
header value can be changed with the <code>:cache_control</code> option:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">cache_control<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>public,&nbsp;max-age=<span class="meta embedded line ruby"><span class="punctuation section embedded begin ruby"><span class="source ruby">#{</span></span><span class="source ruby"><span class="constant numeric ruby">7</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">24</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">60</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">60</span></span><span class="punctuation section embedded end ruby"><span class="source ruby">}</span></span></span><span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;7&nbsp;weeks&nbsp;</span></span></div></code></pre>
<p>Note that <code>Cache-Control</code> is added to response headers only when using
<code>Shrine.derivation_endpoint</code> or <code>Shrine.derivation_response</code>, it's not added
when using <code>Shrine::UploadedFile#derivation_response</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="uploading"></a><a href="#uploading" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Uploading</h2>
<p>By default the generated derivatives aren't saved anywhere, which means that
repeated requests to the same derivation URL will call the derivation block
each time. If you don't want to rely on solely on your HTTP cache, you can
enable the <code>:upload</code> option, which will make derivatives automatically cached
on the Shrine storage:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">upload<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span></span></div></code></pre>
<p>Now whenever a derivation is requested, the endpoint will first check whether
the derivative already exists on the storage. If it doesn't exist, it will
fetch the original uploaded file, call the derivation block, upload the
derivative to the storage, and serve the derivative. If the derivative does
exist on checking, the endpoint will download the derivative and serve it.</p>
<h3><a class="anchor" aria-hidden="true" id="upload-location"></a><a href="#upload-location" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Upload location</h3>
<p>The default upload location for derivatives is <code>&lt;source id&gt;/&lt;name&gt;-&lt;args&gt;</code>.
This can be changed with the <code>:upload_location</code> option:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">upload<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">upload_location<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;e.g.&nbsp;&quot;derivatives/9a7d1bfdad24a76f9cfaff137fe1b5c7/thumbnail-1000-800&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="punctuation section array begin ruby">[</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>derivatives<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="support class ruby">File</span><span class="punctuation separator method ruby">.</span>basename<span class="punctuation section function ruby">(</span>source<span class="punctuation separator method ruby">.</span>id<span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>.*<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="punctuation section array begin ruby">[</span>name<span class="punctuation separator object ruby">,</span>&nbsp;<span class="keyword operator arithmetic ruby">*</span>args<span class="punctuation section array end ruby">]</span><span class="punctuation separator method ruby">.</span>join<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>-<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator method ruby">.</span>join<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>/<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section scope end ruby">}</span></span></div></code></pre>
<p>Since the default upload location won't have any file extension, the derivation
response won't know the appropriate <code>Content-Type</code> header value to set, and the
generic <code>application/octet-stream</code> will be used. It's recommended to use the
<a href="#content-type"><code>:type</code></a> option to set the appropriate <code>Content-Type</code> value.</p>
<h3><a class="anchor" aria-hidden="true" id="upload-storage"></a><a href="#upload-storage" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Upload storage</h3>
<p>The target storage used is the same as for the source uploaded file. The
<code>:upload_storage</code> option can be used to specify a different Shrine storage:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">upload<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">upload_storage<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail_storage</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="upload-options"></a><a href="#upload-options" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Upload options</h3>
<p>Additional storage-specific upload options can be passed via <code>:upload_options</code>:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">upload<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">upload_options<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="constant other symbol hashkey ruby">acl<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>public-read<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation section scope end ruby">}</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="upload-open-options"></a><a href="#upload-open-options" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Upload open options</h3>
<p>Additional storage-specific download options for the uploaded derivation result
can be passed via <code>:upload_open_options</code>:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">upload<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">upload_open_options<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="constant other symbol hashkey ruby">response_content_encoding<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>gzip<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation section scope end ruby">}</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="redirecting"></a><a href="#redirecting" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redirecting</h3>
<p>If you are using remote cloud storages, you can configure the endpoint to
redirect the client to the uploaded derivative on the remote storage instead of
serving it through the endpoint (which is the default behaviour) by setting both
<code>:upload</code> and <code>:upload_redirect</code> to <code>true</code>:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">upload<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">upload_redirect<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span></span></div></code></pre>
<p>Additional storage-specific URL options can be passed in for the redirect URL:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">upload<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">upload_redirect<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">upload_redirect_url_options<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="constant other symbol hashkey ruby">public<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span>&nbsp;<span class="punctuation section scope end ruby">}</span></span></div></code></pre>
<p>Note that redirecting only makes sense if you're using remote storage services
such as AWS S3 or Google Cloud Storage.</p>
<h3><a class="anchor" aria-hidden="true" id="deleting-derivatives"></a><a href="#deleting-derivatives" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deleting derivatives</h3>
<p>When the original attachment is deleted, its uploaded derivatives will not be
automatically deleted, you will need to do the deletion manually. If you're
using <a href="https://shrinerb.com/docs/plugins/backgrounding">backgrounding</a>, you can do this in your <code>DestroyJob</code>.</p>
<p>If your storage implements <code>#delete_prefixed</code>, and you're using the default
<a href="#upload-location"><code>:upload_location</code></a>, you can delete the directory containing
derivatives:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">DestroyJob<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;ActiveJob::Base</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">perform</span><span class="punctuation definition parameters ruby">(</span><span class="variable parameter function ruby">attacher_class</span>,&nbsp;<span class="variable parameter function ruby">data</span><span class="punctuation definition parameters ruby">)</span></span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;destroy&nbsp;attached&nbsp;file&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;derivatives_directory&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher<span class="punctuation separator method ruby">.</span>file<span class="punctuation separator method ruby">.</span>id&nbsp;<span class="keyword operator arithmetic ruby">+</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>/<span class="punctuation definition string end ruby">&quot;</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;storage&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher<span class="punctuation separator method ruby">.</span>store<span class="punctuation separator method ruby">.</span>storage</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;storage<span class="punctuation separator method ruby">.</span>delete_prefixed<span class="punctuation section function ruby">(</span>derivatives_directory<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>Alternatively, you can delete each derivative individually:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">ImageUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="variable other constant ruby">DERIVATIONS</span>&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="punctuation section array begin ruby">[</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">800</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">800</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">600</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">400</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">400</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">300</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation separator method ruby">...</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="punctuation section array end ruby">]</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">DestroyJob<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;ActiveJob::Base</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">perform</span><span class="punctuation definition parameters ruby">(</span><span class="variable parameter function ruby">attacher_class</span>,&nbsp;<span class="variable parameter function ruby">data</span><span class="punctuation definition parameters ruby">)</span></span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;destroy&nbsp;attached&nbsp;file&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>shrine_class<span class="punctuation separator other ruby">::</span><span class="support class ruby">DERIVATIONS</span><span class="punctuation separator method ruby">.</span>each&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">args</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>file<span class="punctuation separator method ruby">.</span>derivation<span class="punctuation section function ruby">(</span><span class="keyword operator arithmetic ruby">*</span>args<span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>delete</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="cache-busting"></a><a href="#cache-busting" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cache busting</h2>
<p>The derivation endpoint response instructs browsers, CDNs and other clients to
cache the response for a long time. This saves server resources and improves
response times. However, if the derivation block is modified, the derivation
URLs will remain unchanged, which means that old cached derivatives might still
be served.</p>
<p>If you want to ensure derivation URLs don't point to old cached derivatives,
you can add a &quot;version&quot; query parameter to the URL, which will make HTTP caches
treat it as a new URL. You can do this via the <code>:version</code> option:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">version<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="constant numeric ruby">1</span>&nbsp;<span class="keyword control ruby">if</span>&nbsp;name&nbsp;<span class="keyword operator comparison ruby">==</span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span>&nbsp;<span class="punctuation section scope end ruby">}</span></span></div></code></pre>
<p>With the above settings, all <code>:thumbnail</code> derivation URLs will include
<code>version</code> in the query string:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>derivation_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;.../thumbnail/eyJpZCI6ImZvbyIsInN?version=1&amp;signature=...&quot;&nbsp;</span></span></div></code></pre>
<p>You can also bump the <code>:version</code> per URL:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>derivation_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">version<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant numeric ruby">1</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;.../thumbnail/eyJpZCI6ImZvbyIsInN?version=1&amp;signature=...&quot;&nbsp;</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="accessing-source-file"></a><a href="#accessing-source-file" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Accessing source file</h2>
<p>Inside the derivation block we can access the source <code>UploadedFile</code> object via
<code>Shrine::Derivation#source</code>:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">derivation&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">file</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">width</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">height</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;source<span class="punctuation separator method ruby">.</span>id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;9a7d1bfdad24a76f9cfaff137fe1b5c7.jpg&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;source<span class="punctuation separator method ruby">.</span>storage_key&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;:store&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;source<span class="punctuation separator method ruby">.</span>metadata&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;{}&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>By default, when using the derivation endpoint, original metadata of the source
file won't be available in the derivation block. This is because any metadata
we would want to have available would need to be serialized into the derivation
URL, which would make it longer. Instead, you can opt in for the metadata you
want to have available:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">metadata<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section array begin ruby">[</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>filename<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>mime_type<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section array end ruby">]</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">derivation&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">file</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">width</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">height</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;source<span class="punctuation separator method ruby">.</span>metadata&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;{&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&quot;filename&quot;&nbsp;=&gt;&nbsp;&quot;nature.jpg&quot;,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&quot;mime_type&quot;&nbsp;=&gt;&nbsp;&quot;image/jpeg&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;}&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;source<span class="punctuation separator method ruby">.</span>original_filename&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;nature.jpg&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;source<span class="punctuation separator method ruby">.</span>mime_type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;image/jpeg&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="downloading"></a><a href="#downloading" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Downloading</h2>
<p>When a derivation is requested, the original uploaded file will be downloaded
to disk before the derivation block is called. If you want to pass in
additional storage-specific download options, you can do so via
<code>:download_options</code>:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">download_options<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">sse_customer_algorithm<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>AES256<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">sse_customer_key<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>secret_key<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">sse_customer_key_md5<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>secret_key_md5<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section scope end ruby">}</span></span></div></code></pre>
<p>If the source file was not found, <code>Shrine::Derivation::SourceNotFound</code>
exception is raised. In a derivation response this is converted into a <code>404 Not Found</code> response.</p>
<h3><a class="anchor" aria-hidden="true" id="skipping-download"></a><a href="#skipping-download" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Skipping download</h3>
<p>If for whatever reason you don't want the uploaded file to be downloaded to
disk for you, you can set <code>:download</code> to <code>false</code>.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">download<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">false</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">derivation&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">width</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">height</span><span class="punctuation separator variable ruby">|</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;source&nbsp;file&nbsp;is&nbsp;not&nbsp;downloaded&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>One use case for this is delegating processing to a 3rd-party service:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>down/http<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">derivation&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">width</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">height</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;generate&nbsp;the&nbsp;thumbnail&nbsp;using&nbsp;ImageOptim.com&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;down&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Down</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Http</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">method<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>post</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;down<span class="punctuation separator method ruby">.</span>download<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span><span class="markup underline link https hyperlink">https://im2.io/</span>&lt;USERNAME&gt;/<span class="meta embedded line ruby"><span class="punctuation section embedded begin ruby"><span class="source ruby">#{</span></span><span class="source ruby">width</span><span class="punctuation section embedded end ruby"><span class="source ruby">}</span></span></span>x<span class="meta embedded line ruby"><span class="punctuation section embedded begin ruby"><span class="source ruby">#{</span></span><span class="source ruby">height</span><span class="punctuation section embedded end ruby"><span class="source ruby">}</span></span></span>/<span class="meta embedded line ruby"><span class="punctuation section embedded begin ruby"><span class="source ruby">#{</span></span><span class="source ruby">source<span class="punctuation separator method ruby">.</span>url</span><span class="punctuation section embedded end ruby"><span class="source ruby">}</span></span></span><span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="derivation-api"></a><a href="#derivation-api" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Derivation API</h2>
<p>In addition to generating derivation responses, it's also possible to operate
with derivations on a lower level. You can access that API by calling
<code>UploadedFile#derivation</code>, which returns a <code>Derivation</code> object.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">derivation&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;uploaded_file<span class="punctuation separator method ruby">.</span>derivation<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">500</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">500</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">derivation&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::Derivation:&nbsp;@name=:thumbnail,&nbsp;@args=[500,&nbsp;500]&nbsp;...&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">derivation<span class="punctuation separator method ruby">.</span>name&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;:thumbnail&nbsp;</span></span></div><div class="line"><span class="source ruby">derivation<span class="punctuation separator method ruby">.</span>args&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;[500,&nbsp;500]&nbsp;</span></span></div><div class="line"><span class="source ruby">derivation<span class="punctuation separator method ruby">.</span>source&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&gt;&nbsp;</span></span></div></code></pre>
<p>When initializing the <code>Derivation</code> object you can override any plugin options:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>derivation<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>grayscale</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">upload_storage<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>other_storage</span><span class="punctuation section function ruby">)</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="url"></a><a href="#url" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>#url</code></h3>
<p><code>Derivation#url</code> method (called by <code>UploadedFile#derivation_url</code>) generates the
URL to the derivation.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">derivation<span class="punctuation separator method ruby">.</span>url&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;/thumbnail/500/400/eyJpZCI6ImZvbyIsInN0b3JhZ2UiOiJzdG9yZSJ9?signature=...&quot;&nbsp;</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="response"></a><a href="#response" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>#response</code></h3>
<p><code>Derivation#response</code> method (called by <code>UploadedFile#derivation_response</code>)
generates appropriate status, headers, and body for the derivative to be
returned as an HTTP response.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">status<span class="punctuation separator object ruby">,</span>&nbsp;headers<span class="punctuation separator object ruby">,</span>&nbsp;body&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;derivation<span class="punctuation separator method ruby">.</span>response</span></div><div class="line"><span class="source ruby">status&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;200&nbsp;</span></span></div><div class="line"><span class="source ruby">headers&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;{&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;Content-Type&quot;&nbsp;=&gt;&nbsp;&quot;image/jpeg&quot;,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;Content-Length&quot;&nbsp;=&gt;&nbsp;&quot;12424&quot;,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;Content-Disposition&quot;&nbsp;=&gt;&nbsp;&quot;inline;&nbsp;filename=\&quot;thumbnail-500-500-k9f8sdksdfk2414\&quot;&quot;,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;Accept_Ranges&quot;&nbsp;=&gt;&nbsp;&quot;bytes&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;}&nbsp;</span></span></div><div class="line"><span class="source ruby">body&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#each&nbsp;object&nbsp;that&nbsp;yields&nbsp;derivative&nbsp;content&nbsp;</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="processed"></a><a href="#processed" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>#processed</code></h3>
<p><code>Derivation#processed</code> method returns the processed derivative. If
<a href="#uploading"><code>:upload</code></a> is enabled, it returns a <code>Shrine::UploadedFile</code> object
pointing to the derivative, processing and uploading the derivative if it
hasn't been already.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;derivation<span class="punctuation separator method ruby">.</span>processed</span></div><div class="line"><span class="source ruby">uploaded_file&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>id&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;bcfd0d67e4a8ec2dc9a6d7ddcf3825a1/thumbnail-500-500&quot;&nbsp;</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="generate"></a><a href="#generate" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>#generate</code></h3>
<p><code>Derivation#generate</code> method calls the derivation block and returns the result.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">result&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;derivation<span class="punctuation separator method ruby">.</span>generate</span></div><div class="line"><span class="source ruby">result&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Tempfile:...&gt;&nbsp;</span></span></div></code></pre>
<p>Internally it will download the source uploaded file to disk and pass it to the
derivation block (unless <code>:download</code> was disabled). You can also pass in an
already downloaded source file:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">derivation<span class="punctuation separator method ruby">.</span>generate<span class="punctuation section function ruby">(</span>source_file<span class="punctuation section function ruby">)</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="upload"></a><a href="#upload" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>#upload</code></h3>
<p><code>Derivation#upload</code> method uploads the given file to the configured derivation
location.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;derivation<span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>file<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">uploaded_file&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>id&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;bcfd0d67e4a8ec2dc9a6d7ddcf3825a1/thumbnail-500-500&quot;&nbsp;</span></span></div></code></pre>
<p>It can also be called without arguments, in which case it will generate a new
derivative and upload it.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">derivation<span class="punctuation separator method ruby">.</span>upload&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;generates&nbsp;derivative&nbsp;and&nbsp;uploads&nbsp;it&nbsp;</span></span></div></code></pre>
<p>Any additional options will be passed to the uploader.</p>
<h3><a class="anchor" aria-hidden="true" id="retrieve"></a><a href="#retrieve" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>#retrieve</code></h3>
<p><code>Derivation#retrieve</code> method returns <code>Shrine::UploadedFile</code> object pointing to
the uploaded derivative if it exists. If the uploaded derivative does not
exist, <code>nil</code> is returned.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;derivation<span class="punctuation separator method ruby">.</span>retrieve</span></div><div class="line"><span class="source ruby">uploaded_file&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>id&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;bcfd0d67e4a8ec2dc9a6d7ddcf3825a1/thumbnail-500-500&quot;&nbsp;</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="opened"></a><a href="#opened" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>#opened</code></h3>
<p><code>Derivation#opened</code> method returns opened <code>Shrine::UploadedFile</code> object pointing
to the uploaded derivative if it exists. If the uploaded derivative does not
exist, <code>nil</code> is returned.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;derivation<span class="punctuation separator method ruby">.</span>opened</span></div><div class="line"><span class="source ruby">uploaded_file&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>id&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;bcfd0d67e4a8ec2dc9a6d7ddcf3825a1/thumbnail-500-500&quot;&nbsp;</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="delete"></a><a href="#delete" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>#delete</code></h3>
<p><code>Derivation#delete</code> method deletes the uploaded derivative file from the
storage.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">derivation<span class="punctuation separator method ruby">.</span>delete</span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="option"></a><a href="#option" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>#option</code></h3>
<p><code>Derivation#option</code> returns the value of the specified plugin option.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">derivation<span class="punctuation separator method ruby">.</span>option<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>upload_location</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;bcfd0d67e4a8ec2dc9a6d7ddcf3825a1/thumbnail-500-500&quot;&nbsp;</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="plugin-options"></a><a href="#plugin-options" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Plugin Options</h2>
<table>
<thead>
<tr><th style="text-align:left">Name</th><th style="text-align:left">Description</th><th style="text-align:left">Default</th></tr>
</thead>
<tbody>
<tr><td style="text-align:left"><code>:cache_control</code></td><td style="text-align:left">Hash of directives for the <code>Cache-Control</code> response header</td><td style="text-align:left"><code>{ public: true, max_age: 365*24*60*60 }</code></td></tr>
<tr><td style="text-align:left"><code>:disposition</code></td><td style="text-align:left">Whether the browser should attempt to render the derivative (<code>inline</code>) or prompt the user to download the file to disk (<code>attachment</code>)</td><td style="text-align:left"><code>inline</code></td></tr>
<tr><td style="text-align:left"><code>:download</code></td><td style="text-align:left">Whether the source uploaded file should be downloaded to disk when the derivation block is called</td><td style="text-align:left"><code>true</code></td></tr>
<tr><td style="text-align:left"><code>:download_options</code></td><td style="text-align:left">Additional options to pass when downloading the source uploaded file</td><td style="text-align:left"><code>{}</code></td></tr>
<tr><td style="text-align:left"><code>:expires_in</code></td><td style="text-align:left">Number of seconds after which the URL will not be available anymore</td><td style="text-align:left"><code>nil</code></td></tr>
<tr><td style="text-align:left"><code>:filename</code></td><td style="text-align:left">Filename the browser will assume when the derivative is downloaded to disk</td><td style="text-align:left"><code>&lt;name&gt;-&lt;args&gt;-&lt;source id basename&gt;</code></td></tr>
<tr><td style="text-align:left"><code>:host</code></td><td style="text-align:left">URL host to use when for URLs</td><td style="text-align:left"><code>nil</code></td></tr>
<tr><td style="text-align:left"><code>:metadata</code></td><td style="text-align:left">List of metadata keys the source uploaded file should include in the derivation block</td><td style="text-align:left"><code>[]</code></td></tr>
<tr><td style="text-align:left"><code>:prefix</code></td><td style="text-align:left">Path prefix added to the URLs</td><td style="text-align:left"><code>nil</code></td></tr>
<tr><td style="text-align:left"><code>:secret_key</code></td><td style="text-align:left">Key used to sign derivation URLs in order to prevent tampering</td><td style="text-align:left">required</td></tr>
<tr><td style="text-align:left"><code>:type</code></td><td style="text-align:left">Media type returned in the <code>Content-Type</code> response header in the derivation response</td><td style="text-align:left">determined from derivative's extension when possible</td></tr>
<tr><td style="text-align:left"><code>:upload</code></td><td style="text-align:left">Whether the generated derivatives will be cached on the storage</td><td style="text-align:left"><code>false</code></td></tr>
<tr><td style="text-align:left"><code>:upload_location</code></td><td style="text-align:left">Location to which the derivatives will be uploaded on the storage</td><td style="text-align:left"><code>&lt;source id&gt;/&lt;name&gt;-&lt;args&gt;</code></td></tr>
<tr><td style="text-align:left"><code>:upload_options</code></td><td style="text-align:left">Additional options to be passed when uploading derivatives</td><td style="text-align:left"><code>{}</code></td></tr>
<tr><td style="text-align:left"><code>:upload_open_options</code></td><td style="text-align:left">Additional options to be passed when downloading the uploaded derivative</td><td style="text-align:left"><code>{}</code></td></tr>
<tr><td style="text-align:left"><code>:upload_redirect</code></td><td style="text-align:left">Whether the derivation response should redirect to the uploaded derivative</td><td style="text-align:left"><code>false</code></td></tr>
<tr><td style="text-align:left"><code>:upload_redirect_url_options</code></td><td style="text-align:left">Additional options to be passed when generating the URL for the uploaded derivative</td><td style="text-align:left"><code>{}</code></td></tr>
<tr><td style="text-align:left"><code>:upload_storage</code></td><td style="text-align:left">Storage to which the derivations will be uploaded</td><td style="text-align:left">same storage as the source file</td></tr>
<tr><td style="text-align:left"><code>:version</code></td><td style="text-align:left">Version number to append to the URL for cache busting</td><td style="text-align:left"><code>nil</code></td></tr>
</tbody>
</table>
<h2><a class="anchor" aria-hidden="true" id="instrumentation"></a><a href="#instrumentation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Instrumentation</h2>
<p>If the <code>instrumentation</code> plugin has been loaded, the <code>determine_mime_type</code> plugin
adds instrumentation around derivation processing.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;instrumentation&nbsp;plugin&nbsp;needs&nbsp;to&nbsp;be&nbsp;loaded&nbsp;*before*&nbsp;derivation_endpoint&nbsp;</span></span></div><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>instrumentation</span></span></div><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span></span></div></code></pre>
<p>Derivation processing will trigger a <code>derivation.shrine</code> event with the
following payload:</p>
<table>
<thead>
<tr><th style="text-align:left">Key</th><th style="text-align:left">Description</th></tr>
</thead>
<tbody>
<tr><td style="text-align:left"><code>:derivation</code></td><td style="text-align:left"><code>Shrine::Derivation</code> object for this processing</td></tr>
<tr><td style="text-align:left"><code>:uploader</code></td><td style="text-align:left">The uploader class that sent the event</td></tr>
</tbody>
</table>
<p>A default log subscriber is added as well which logs these events:</p>
<pre><code class="hljs">Derivation (492ms) – {:name=>:thumbnail, :args=>[600, 600], :uploader=>Shrine}
</code></pre>
<p>You can also use your own log subscriber:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">log_subscriber<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section function ruby">(</span>event<span class="punctuation section function ruby">)</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>logger<span class="punctuation separator method ruby">.</span>info&nbsp;<span class="support class ruby">JSON</span><span class="punctuation separator method ruby">.</span>generate<span class="punctuation section function ruby">(</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">name<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;event<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">duration<span class="punctuation definition constant ruby">:</span></span>&nbsp;event<span class="punctuation separator method ruby">.</span>duration<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">name<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;event<span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">args<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;event<span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation</span><span class="punctuation section array end ruby">]</span><span class="punctuation separator method ruby">.</span>args<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section scope end ruby">}</span></span></div></code></pre>
<pre><code class="hljs">{"name":"derivation","duration":492,"name":"thumbnail","args":[600,600],"uploader":"Shrine"}
</code></pre>
<p>Or disable logging altogether:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">log_subscriber<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language nil ruby">nil</span></span></div></code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/plugins/upload_endpoint"><span class="arrow-prev">← </span><span>Upload Endpoint</span></a><a class="docs-next button" href="/docs/plugins/derivatives"><span>Derivatives</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#quick-start">Quick start</a></li><li><a href="#how-it-works">How it works</a><ul class="toc-headings"><li><a href="#performance">Performance</a></li></ul></li><li><a href="#derivation-response">Derivation response</a></li><li><a href="#dynamic-settings">Dynamic settings</a></li><li><a href="#host">Host</a></li><li><a href="#prefix">Prefix</a></li><li><a href="#expiration">Expiration</a></li><li><a href="#response-headers">Response headers</a><ul class="toc-headings"><li><a href="#content-type">Content Type</a></li><li><a href="#content-disposition">Content Disposition</a></li><li><a href="#cache-control">Cache Control</a></li></ul></li><li><a href="#uploading">Uploading</a><ul class="toc-headings"><li><a href="#upload-location">Upload location</a></li><li><a href="#upload-storage">Upload storage</a></li><li><a href="#upload-options">Upload options</a></li><li><a href="#upload-open-options">Upload open options</a></li><li><a href="#redirecting">Redirecting</a></li><li><a href="#deleting-derivatives">Deleting derivatives</a></li></ul></li><li><a href="#cache-busting">Cache busting</a></li><li><a href="#accessing-source-file">Accessing source file</a></li><li><a href="#downloading">Downloading</a><ul class="toc-headings"><li><a href="#skipping-download">Skipping download</a></li></ul></li><li><a href="#derivation-api">Derivation API</a><ul class="toc-headings"><li><a href="#url"><code>#url</code></a></li><li><a href="#response"><code>#response</code></a></li><li><a href="#processed"><code>#processed</code></a></li><li><a href="#generate"><code>#generate</code></a></li><li><a href="#upload"><code>#upload</code></a></li><li><a href="#retrieve"><code>#retrieve</code></a></li><li><a href="#opened"><code>#opened</code></a></li><li><a href="#delete"><code>#delete</code></a></li><li><a href="#option"><code>#option</code></a></li></ul></li><li><a href="#plugin-options">Plugin Options</a></li><li><a href="#instrumentation">Instrumentation</a></li></ul></nav></div><footer class="nav-footer" id="footer" data-version="3.4.0"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/logo.png" alt="Shrine" width="66"/></a><div><h5>Docs</h5><a href="/guides">Guides</a><a href="/plugins">Plugins</a><a href="/external">External</a><a href="https://github.com/shrinerb/shrine/blob/master/CONTRIBUTING.md#readme">Contributing</a></div><div><h5>Community</h5><a href="https://discourse.shrinerb.com" target="_blank" rel="noreferrer noopener">Discourse</a><a href="https://stackoverflow.com/questions/tagged/shrine" target="_blank" rel="noreferrer noopener">Stack Overflow</a></div><div><h5>More</h5><a href="https://twin.github.io">Blog</a><a href="https://github.com/shrinerb/shrine">GitHub</a><a class="github-button" href="https://github.com/shrinerb/shrine" data-icon="octicon-star" data-count-href="/shrinerb/shrine/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a><div class="social"><a href="https://twitter.com/shrine_rb" class="twitter-follow-button">Follow @shrine_rb</a></div></div></section><section class="copyright">Copyright © 2022 Janko Marohnić</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '09a11b10801874df7d226df4f2ce8e8f',
                indexName: 'shrinerb',
                inputSelector: '#search_input_react'
              });
            </script></body></html>