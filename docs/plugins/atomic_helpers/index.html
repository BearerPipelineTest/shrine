<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Atomic Helpers · Shrine</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="The [`atomic_helpers`][atomic_helpers] plugin provides API for retrieving and"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Atomic Helpers · Shrine"/><meta property="og:type" content="website"/><meta property="og:url" content="https://shrinerb.com/"/><meta property="og:description" content="The [`atomic_helpers`][atomic_helpers] plugin provides API for retrieving and"/><meta property="og:image" content="https://shrinerb.com/img/logo.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://shrinerb.com/img/logo.png"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-149836844-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/js/version.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.png" alt="Shrine"/><h2 class="headerTitleWithLogo">Shrine</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/getting-started" target="_self">Guides</a></li><li class="siteNavGroupActive"><a href="/docs/plugins/activerecord" target="_self">Plugins</a></li><li class=""><a href="/docs/external/extensions" target="_self">External</a></li><li class=""><a href="https://discourse.shrinerb.com" target="_blank">Discourse</a></li><li class=""><a href="https://github.com/shrinerb/shrine" target="_blank">GitHub</a></li><li class=""><a href="https://github.com/shrinerb/shrine/wiki" target="_blank">Wiki</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Other</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Attachment</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/activerecord">Active Record</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/column">Column</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/entity">Entity</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/model">Model</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/sequel">Sequel</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Flow</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/backgrounding">Backgrounding</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/presign_endpoint">Presign Endpoint</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/upload_endpoint">Upload Endpoint</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Processing</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/derivation_endpoint">Derivation Endpoint</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/derivatives">Derivatives</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Source</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/data_uri">Data URI</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/rack_file">Rack File</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/remote_url">Remote URL</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Validation</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/remove_invalid">Remove Invalid</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/validation">Validation</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/validation_helpers">Validation Helpers</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Metadata</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/add_metadata">Add Metadata</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/determine_mime_type">Determine MIME Type</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/infer_extension">Infer Extension</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/metadata_attributes">Metadata Attributes</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/refresh_metadata">Refresh Metadata</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/restore_cached_data">Restore Cached Data</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/signature">Signature</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/store_dimensions">Store Dimensions</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/type_predicates">Type Predicates</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Downloading</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/download_endpoint">Download Endpoint</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/rack_response">Rack Response</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/tempfile">Tempfile</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Form</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/cached_attachment_data">Cached Attachment Data</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/form_assign">Form Assign</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/remove_attachment">Remove Attachment</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Settings</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/plugins/default_storage">Default Storage</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/default_url">Default URL</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/dynamic_storage">Dynamic Storage</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/multi_cache">Multi Cache</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/pretty_location">Pretty Location</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/upload_options">Upload Options</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/url_options">URL Options</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Other</h3><ul class=""><li class="navListItem navListItemActive"><a class="navItem" href="/docs/plugins/atomic_helpers">Atomic Helpers</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/included">Included</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/instrumentation">Instrumentation</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/keep_files">Keep Files</a></li><li class="navListItem"><a class="navItem" href="/docs/plugins/mirroring">Mirroring</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/shrinerb/shrine/edit/master/doc/plugins/atomic_helpers.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 id="__docusaurus" class="postHeaderTitle">Atomic Helpers</h1></header><article><div><span><p>The <a href="https://github.com/shrinerb/shrine/blob/master/lib/shrine/plugins/atomic_helpers.rb"><code>atomic_helpers</code></a> plugin provides API for retrieving and
persisting attachments in a concurrency-safe way, which is especially useful
when using the <code>backgrounding</code> plugin. The database plugins (<code>activerecord</code>
and <code>sequel</code>) implement atomic promotion and atomic persistence on top of this
plugin.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>atomic_helpers</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="problem-statement"></a><a href="#problem-statement" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Problem Statement</h2>
<p>What happens if two different processors (web workers, background jobs,
command-line executions, whatever) try to edit a shrine attachment
concurrently? The kinds of edits typically made include: &quot;promoting a file&quot;,
moving it to a different storage and persisting that change in the model;
adding or changing a derivative; adding or changing a metadata element.</p>
<p>There are two main categories of &quot;race condition&quot;:</p>
<ol>
<li><p>The file could be switched out from under you. If you were promoting a file,
but some other process has <em>changed</em> the attachment, you don't want to
overwrite it with the promomoted version of the <em>prior</em> attacchment. Likewise,
if you were adding metadata or a derivative, they would be corresponding to a
certain attachment, and you don't want to accidentally add them to a now changed
attacchment for which they are inappropriate.</p></li>
<li><p>Overwriting each other's edits. Since all shrine (meta)data is stored in a
single JSON hash, standard implementations will write the entire JSON hash at
once to a rdbms column or other store. If two processes both read in the hash,
make a change to different keys in it, and then write it back out, the second
process to write will 'win' and overwrite changes made by the first.</p></li>
</ol>
<p>The atomic helpers give you tools to avoid both of these sorts of race
conditions, under conditions of concurrent editing.</p>
<h2><a class="anchor" aria-hidden="true" id="high-level-orm-helpers"></a><a href="#high-level-orm-helpers" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>High-level ORM helpers</h2>
<p>If you are using the <code>sequel</code> or <code>activerecord</code> plugins, they give you two
higher-level helpers: <code>atomic_persist</code> and <code>atomic_promote</code>. See the
<a href="https://shrinerb.com/docs/plugins/persistence">persistence</a>  documentation for more.</p>
<h2><a class="anchor" aria-hidden="true" id="retrieving"></a><a href="#retrieving" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Retrieving</h2>
<p>The <code>Attacher.retrieve</code> method provided by the plugin instantiates an attacher
from a record instance, attachment name and attachment data, asserting that the
given attachment data matches the attached file on the record.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;with&nbsp;a&nbsp;model&nbsp;instance&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>retrieve<span class="punctuation section function ruby">(</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">model<span class="punctuation definition constant ruby">:</span></span>&nbsp;photo<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">name<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">file<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>id<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>abc123<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>storage<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>cache<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::Attacher&nbsp;...&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;with&nbsp;an&nbsp;entity&nbsp;instance&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>retrieve<span class="punctuation section function ruby">(</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">entity<span class="punctuation definition constant ruby">:</span></span>&nbsp;photo<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">name<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">file<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>id<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>abc123<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>storage<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>cache<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::Attacher&nbsp;...&gt;&nbsp;</span></span></div></code></pre>
<p>If the record has <code>Shrine::Attachment</code> included, the <code>#&lt;name&gt;_attacher</code> method
will be called on the record, which will return the correct attacher class.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">Photo</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">include</span>&nbsp;<span class="support class ruby">ImageUploader</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Attachment</span><span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>retrieve<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">model<span class="punctuation definition constant ruby">:</span></span>&nbsp;photo<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">name<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">file<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="punctuation separator method ruby">...</span>&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;ImageUploader::Attacher&nbsp;...&gt;&nbsp;</span></span></div></code></pre>
<p>Otherwise it will call <code>Attacher.from_model</code>/<code>Attacher.from_entity</code> from the
<code>model</code>/<code>entity</code> plugin, in which case you need to make sure to call
<code>Attacher.retrieve</code> on the appropriate attacher class.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">ImageUploader</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>retrieve<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">entity<span class="punctuation definition constant ruby">:</span></span>&nbsp;photo<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">name<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">file<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="punctuation separator method ruby">...</span>&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;ImageUploader::Attacher&nbsp;...&gt;&nbsp;</span></span></div></code></pre>
<p>If the attached file on the record doesn't match the provided attachment data,
a <code>Shrine::AttachmentChanged</code> exception is raised. Note that metadata is
allowed to differ, Shrine will only compare location and storage of the file.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image_data&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&#39;{&quot;id&quot;:&quot;foo&quot;,&quot;storage&quot;:&quot;store&quot;,&quot;metadata&quot;:{...}}&#39;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>retrieve<span class="punctuation section function ruby">(</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">model<span class="punctuation definition constant ruby">:</span></span>&nbsp;photo<span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">name<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">file<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>id<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>bar<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>storage<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>store<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;~&gt;&nbsp;Shrine::AttachmentChanged:&nbsp;attachment&nbsp;has&nbsp;changed&nbsp;</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="file-data"></a><a href="#file-data" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>File data</h3>
<p>The <code>Attacher#file_data</code> method can be used for sending the attached file data
into a background job. It returns only location and storage of the attached
file, leaving out any metadata or derivatives data that <code>Attacher#data</code> would
return. This way the background job payload is kept light.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>file_data&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;{&nbsp;&quot;id&quot;&nbsp;=&gt;&nbsp;&quot;abc123&quot;,&nbsp;&quot;storage&quot;&nbsp;=&gt;&nbsp;&quot;store&quot;&nbsp;}&nbsp;</span></span></div></code></pre>
<p>This value can then be passed as the <code>:file</code> argument to
<code>Shrine::Attacher.retrieve</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="promoting"></a><a href="#promoting" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promoting</h2>
<p>The <code>Attacher#abstract_atomic_promote</code> method provided by the plugin promotes
the cached file to permanent storage, reloads the record to check whether the
attachment hasn't changed, and if not persists the promoted file.</p>
<p>Internally it calls <code>Attacher#abstract_atomic_persist</code> to do the persistence,
forwarding <code>:reload</code> and <code>:persist</code> options as well as a given block to it (see
the next section for more details).</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;in&nbsp;the&nbsp;controller&nbsp;</span></span></div><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>attach_cached<span class="punctuation section function ruby">(</span>io<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>cached?&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;true&nbsp;</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;in&nbsp;a&nbsp;background&nbsp;job&nbsp;</span></span></div><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>abstract_atomic_promote<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">reload<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section function ruby">(</span><span class="keyword operator arithmetic ruby">&amp;</span>block<span class="punctuation section function ruby">)</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="punctuation separator method ruby">...</span>&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">persist<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="punctuation separator method ruby">...</span>&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>stored?&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;true&nbsp;</span></span></div></code></pre>
<p>If the attachment has changed during promotion, the promoted file is deleted and
a <code>Shrine::AttachmentChanged</code> exception is raised.</p>
<p>If you want to execute some code after the attachment change check but before
persistence, you can pass a block:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>abstract_atomic_promote<span class="punctuation section function ruby">(</span><span class="keyword operator arithmetic ruby">**</span>options<span class="punctuation section function ruby">)</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">reloaded_attacher</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;this&nbsp;will&nbsp;be&nbsp;executed&nbsp;before&nbsp;persistence&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>Any additional options to <code>Attacher#abstract_atomic_promote</code> are forwarded to
<code>Attacher#promote</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="persisting"></a><a href="#persisting" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Persisting</h2>
<p>The <code>Attacher#abstract_atomic_persist</code> method reloads the record to check
whether the attachment hasn't changed, and if not persists the attachment.</p>
<p>It requires reloader and persister to be passed in, as they will be specific to
the database library you're using. The reloader needs to call the given block
with the reloaded record, while the persister needs to persist the promoted
file.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>abstract_atomic_persist<span class="punctuation section function ruby">(</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">reload<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section function ruby">(</span><span class="keyword operator arithmetic ruby">&amp;</span>block<span class="punctuation section function ruby">)</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="punctuation separator method ruby">...</span>&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;call&nbsp;the&nbsp;block&nbsp;with&nbsp;reloaded&nbsp;record&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">persist<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="punctuation separator method ruby">...</span>&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation separator object ruby">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;persist&nbsp;promoted&nbsp;file&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section function ruby">)</span></span></div></code></pre>
<p>To illustrate, this is how the <code>Attacher#atomic_promote</code> method provided by the
<code>sequel</code> plugin is implemented:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>abstract_atomic_persist<span class="punctuation section function ruby">(</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">reload<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section function ruby">(</span><span class="keyword operator arithmetic ruby">&amp;</span>block<span class="punctuation section function ruby">)</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>record<span class="punctuation separator method ruby">.</span>db<span class="punctuation separator method ruby">.</span>transaction&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;block<span class="punctuation separator method ruby">.</span>call&nbsp;attacher<span class="punctuation separator method ruby">.</span>record<span class="punctuation separator method ruby">.</span>dup<span class="punctuation separator method ruby">.</span>lock!&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;the&nbsp;DB&nbsp;lock&nbsp;ensures&nbsp;no&nbsp;changes&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">persist<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>record<span class="punctuation separator method ruby">.</span>save_changes<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">validate<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">false</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section function ruby">)</span></span></div></code></pre>
<p>By default, the file currently set on the attacher will be considered the
original file, and will be compared to the reloaded record. You can specify a
different original file:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">original_file&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher<span class="punctuation separator method ruby">.</span>file</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>set<span class="punctuation section function ruby">(</span>new_file<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>abstract_atomic_persist<span class="punctuation section function ruby">(</span>original_file<span class="punctuation separator object ruby">,</span>&nbsp;<span class="keyword operator arithmetic ruby">**</span>options<span class="punctuation section function ruby">)</span></span></div></code></pre>
<p>If you want to execute some code after the attachment change check but before
persistence, you can pass a block:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>abstract_atomic_persist<span class="punctuation section function ruby">(</span><span class="keyword operator arithmetic ruby">**</span>options<span class="punctuation section function ruby">)</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">reloaded_attacher</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;this&nbsp;will&nbsp;be&nbsp;executed&nbsp;before&nbsp;persistence&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/plugins/url_options"><span class="arrow-prev">← </span><span>URL Options</span></a><a class="docs-next button" href="/docs/plugins/included"><span>Included</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#problem-statement">Problem Statement</a></li><li><a href="#high-level-orm-helpers">High-level ORM helpers</a></li><li><a href="#retrieving">Retrieving</a><ul class="toc-headings"><li><a href="#file-data">File data</a></li></ul></li><li><a href="#promoting">Promoting</a></li><li><a href="#persisting">Persisting</a></li></ul></nav></div><footer class="nav-footer" id="footer" data-version="3.4.0"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/logo.png" alt="Shrine" width="66"/></a><div><h5>Docs</h5><a href="/guides">Guides</a><a href="/plugins">Plugins</a><a href="/external">External</a><a href="https://github.com/shrinerb/shrine/blob/master/CONTRIBUTING.md#readme">Contributing</a></div><div><h5>Community</h5><a href="https://discourse.shrinerb.com" target="_blank" rel="noreferrer noopener">Discourse</a><a href="https://stackoverflow.com/questions/tagged/shrine" target="_blank" rel="noreferrer noopener">Stack Overflow</a></div><div><h5>More</h5><a href="https://twin.github.io">Blog</a><a href="https://github.com/shrinerb/shrine">GitHub</a><a class="github-button" href="https://github.com/shrinerb/shrine" data-icon="octicon-star" data-count-href="/shrinerb/shrine/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a><div class="social"><a href="https://twitter.com/shrine_rb" class="twitter-follow-button">Follow @shrine_rb</a></div></div></section><section class="copyright">Copyright © 2022 Janko Marohnić</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '09a11b10801874df7d226df4f2ce8e8f',
                indexName: 'shrinerb',
                inputSelector: '#search_input_react'
              });
            </script></body></html>