<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Getting Started · Shrine</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="## Quick start"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Getting Started · Shrine"/><meta property="og:type" content="website"/><meta property="og:url" content="https://shrinerb.com/"/><meta property="og:description" content="## Quick start"/><meta property="og:image" content="https://shrinerb.com/img/logo.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://shrinerb.com/img/logo.png"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-149836844-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/js/version.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.png" alt="Shrine"/><h2 class="headerTitleWithLogo">Shrine</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive siteNavItemActive"><a href="/docs/getting-started" target="_self">Guides</a></li><li class=""><a href="/docs/plugins/activerecord" target="_self">Plugins</a></li><li class=""><a href="/docs/external/extensions" target="_self">External</a></li><li class=""><a href="https://discourse.shrinerb.com" target="_blank">Discourse</a></li><li class=""><a href="https://github.com/shrinerb/shrine" target="_blank">GitHub</a></li><li class=""><a href="https://github.com/shrinerb/shrine/wiki" target="_blank">Wiki</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Introduction</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Introduction</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/advantages">Advantages of Shrine</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/getting-started">Getting Started</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Base</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/design">The Design of Shrine</a></li><li class="navListItem"><a class="navItem" href="/docs/retrieving-uploads">Retrieving Uploads</a></li><li class="navListItem"><a class="navItem" href="/docs/attacher">Using Attacher</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Storage</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/storage/file-system">File System</a></li><li class="navListItem"><a class="navItem" href="/docs/storage/s3">AWS S3</a></li><li class="navListItem"><a class="navItem" href="/docs/storage/memory">Memory</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Features</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/direct-s3">Direct Uploads to S3</a></li><li class="navListItem"><a class="navItem" href="/docs/metadata">Extracting Metadata</a></li><li class="navListItem"><a class="navItem" href="/docs/processing">File Processing</a></li><li class="navListItem"><a class="navItem" href="/docs/validation">File Validation</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Extras</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/multiple-files">Multiple Files</a></li><li class="navListItem"><a class="navItem" href="/docs/securing-uploads">Securing Uploads</a></li><li class="navListItem"><a class="navItem" href="/docs/testing">Testing with Shrine</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Migrating</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/changing-derivatives">Managing Derivatives</a></li><li class="navListItem"><a class="navItem" href="/docs/changing-location">Migrating File Locations</a></li><li class="navListItem"><a class="navItem" href="/docs/changing-storage">Migrating File Storage</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Extending</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/creating-plugins">Writing a Plugin</a></li><li class="navListItem"><a class="navItem" href="/docs/creating-persistence-plugins">Writing a Persistence Plugin</a></li><li class="navListItem"><a class="navItem" href="/docs/creating-storages">Writing a Storage</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Upgrading</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/upgrading-to-3">Upgrading to Shrine 3.x</a></li><li class="navListItem"><a class="navItem" href="/docs/carrierwave">Upgrading from CarrierWave</a></li><li class="navListItem"><a class="navItem" href="/docs/paperclip">Upgrading from Paperclip</a></li><li class="navListItem"><a class="navItem" href="/docs/refile">Upgrading from Refile</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/shrinerb/shrine/edit/master/doc/getting_started.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 id="__docusaurus" class="postHeaderTitle">Getting Started</h1></header><article><div><span><h2><a class="anchor" aria-hidden="true" id="quick-start"></a><a href="#quick-start" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Quick start</h2>
<p>Add Shrine to the Gemfile and write an initializer which sets up the storage
and loads integration for your persistence library:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;Gemfile&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>shrine<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>~&gt;&nbsp;3.0<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>shrine<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>shrine/storage/file_system<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>storages&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">cache<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Storage</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">FileSystem</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>public<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">prefix<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>uploads/cache<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;temporary&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">store<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Storage</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">FileSystem</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>public<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">prefix<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>uploads<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span><span class="punctuation separator object ruby">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;permanent&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>sequel</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;or&nbsp;:activerecord&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>cached_attachment_data</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;for&nbsp;retaining&nbsp;the&nbsp;cached&nbsp;file&nbsp;across&nbsp;form&nbsp;redisplays&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>restore_cached_data</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;re-extract&nbsp;metadata&nbsp;when&nbsp;attaching&nbsp;a&nbsp;cached&nbsp;file&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>rack_file</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;for&nbsp;non-Rails&nbsp;apps&nbsp;</span></span></div></code></pre>
<p>Next decide how you will name the attachment attribute on your model, and run a
migration that adds an <code>&lt;attachment&gt;_data</code> text or JSON column, which Shrine
will use to store all information about the attachment:</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-1-tab-2" class="nav-link active" data-group="group_1" data-tab="tab-group-1-content-2">Sequel</div><div id="tab-group-1-tab-3" class="nav-link" data-group="group_1" data-tab="tab-group-1-content-3">ActiveRecord</div><div id="tab-group-1-tab-4" class="nav-link" data-group="group_1" data-tab="tab-group-1-content-4">Rails</div></div><div class="tab-content"><div id="tab-group-1-content-2" class="tab-pane active" data-group="group_1" tabindex="-1"><div><span><pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Sequel</span><span class="punctuation separator method ruby">.</span>migration&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;change&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;add_column&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>photos</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image_data</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>text</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;or&nbsp;:jsonb&nbsp;&nbsp;&nbsp;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
</span></div></div><div id="tab-group-1-content-3" class="tab-pane" data-group="group_1" tabindex="-1"><div><span><pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">AddImageDataToPhotos<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;ActiveRecord::Migration</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method without-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">change</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;add_column&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>photos</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image_data</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>text</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;or&nbsp;:jsonb&nbsp;&nbsp;&nbsp;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
</span></div></div><div id="tab-group-1-content-4" class="tab-pane" data-group="group_1" tabindex="-1"><div><span><pre><code class="language-rb"><div class="line"><span class="source ruby">$&nbsp;rails&nbsp;generate&nbsp;migration&nbsp;add_image_data_to_photos&nbsp;<span class="constant other symbol hashkey ruby">image_data<span class="punctuation definition constant ruby">:</span></span>text&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;or&nbsp;image_data:jsonb&nbsp;&nbsp;</span></span></div></code></pre>
<p>If using <code>jsonb</code> consider adding a [gin index] for fast key-value pair searchability within <code>image_data</code>.</p>
</span></div></div></div></div>
<p>Now you can create an uploader class for the type of files you want to upload,
and add a virtual attribute for handling attachments using this uploader to
your model. If you do not care about adding plugins or additional processing,
you can use <code>Shrine::Attachment</code>.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">ImageUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;plugins&nbsp;and&nbsp;uploading&nbsp;logic&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-5-tab-6" class="nav-link active" data-group="group_5" data-tab="tab-group-5-content-6">Sequel</div><div id="tab-group-5-tab-7" class="nav-link" data-group="group_5" data-tab="tab-group-5-content-7">ActiveRecord</div></div><div class="tab-content"><div id="tab-group-5-content-6" class="tab-pane active" data-group="group_5" tabindex="-1"><div><span><pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">Photo<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Sequel::Model</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">include</span>&nbsp;<span class="support class ruby">ImageUploader</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Attachment</span><span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;adds&nbsp;an&nbsp;`image`&nbsp;virtual&nbsp;attribute&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
</span></div></div><div id="tab-group-5-content-7" class="tab-pane" data-group="group_5" tabindex="-1"><div><span><pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">Photo<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;ActiveRecord::Base</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">include</span>&nbsp;<span class="support class ruby">ImageUploader</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Attachment</span><span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;adds&nbsp;an&nbsp;`image`&nbsp;virtual&nbsp;attribute&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
</span></div></div></div></div>
<p>Let's now add the form fields which will use this virtual attribute (NOT the
<code>&lt;attachment&gt;_data</code> column attribute). We need (1) a file field for choosing
files, and (2) a hidden field for retaining the uploaded file in case of
validation errors and for potential <a href="#direct-uploads">direct uploads</a>.</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-8-tab-9" class="nav-link active" data-group="group_8" data-tab="tab-group-8-content-9">Rails form builder</div><div id="tab-group-8-tab-10" class="nav-link" data-group="group_8" data-tab="tab-group-8-content-10">Simple Form</div><div id="tab-group-8-tab-11" class="nav-link" data-group="group_8" data-tab="tab-group-8-content-11">Forme</div><div id="tab-group-8-tab-12" class="nav-link" data-group="group_8" data-tab="tab-group-8-content-12">HTML</div></div><div class="tab-content"><div id="tab-group-8-content-9" class="tab-pane active" data-group="group_8" tabindex="-1"><div><span><pre><code class="language-rb"><div class="line"><span class="source ruby">form_for&nbsp;<span class="variable other readwrite instance ruby"><span class="punctuation definition variable ruby">@</span>photo</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">f</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;f<span class="punctuation separator method ruby">.</span>hidden_field&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">value<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="variable other readwrite instance ruby"><span class="punctuation definition variable ruby">@</span>photo</span><span class="punctuation separator method ruby">.</span>cached_image_data</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;f<span class="punctuation separator method ruby">.</span>file_field&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;f<span class="punctuation separator method ruby">.</span>submit</span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
</span></div></div><div id="tab-group-8-content-10" class="tab-pane" data-group="group_8" tabindex="-1"><div><span><pre><code class="language-rb"><div class="line"><span class="source ruby">simple_form_for&nbsp;<span class="variable other readwrite instance ruby"><span class="punctuation definition variable ruby">@</span>photo</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">f</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;f<span class="punctuation separator method ruby">.</span>input&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">as<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>hidden</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">input_html<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="constant other symbol hashkey ruby">value<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="variable other readwrite instance ruby"><span class="punctuation definition variable ruby">@</span>photo</span><span class="punctuation separator method ruby">.</span>cached_image_data&nbsp;<span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;f<span class="punctuation separator method ruby">.</span>input&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">as<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>file</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;f<span class="punctuation separator method ruby">.</span>button&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>submit</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
</span></div></div><div id="tab-group-8-content-11" class="tab-pane" data-group="group_8" tabindex="-1"><div><span><pre><code class="language-rb"><div class="line"><span class="source ruby">form&nbsp;<span class="variable other readwrite instance ruby"><span class="punctuation definition variable ruby">@</span>photo</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">action<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>/photos<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">enctype<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>multipart/form-data<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">f</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;f<span class="punctuation separator method ruby">.</span>input&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">type<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>hidden</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">value<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="variable other readwrite instance ruby"><span class="punctuation definition variable ruby">@</span>photo</span><span class="punctuation separator method ruby">.</span>cached_image_data</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;f<span class="punctuation separator method ruby">.</span>input&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">type<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>file</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;f<span class="punctuation separator method ruby">.</span>button&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>Create<span class="punctuation definition string end ruby">&quot;</span></span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
</span></div></div><div id="tab-group-8-content-12" class="tab-pane" data-group="group_8" tabindex="-1"><div><span><pre><code class="language-erb"><div class="line"><span class="text html erb"><span class="meta tag block any html"><span class="punctuation definition tag begin html">&lt;</span><span class="entity name tag block any html">form</span>&nbsp;<span class="entity other attribute-name html">action</span>=<span class="string quoted double html"><span class="punctuation definition string begin html">&quot;</span>/photos<span class="punctuation definition string end html">&quot;</span></span>&nbsp;<span class="entity other attribute-name html">method</span>=<span class="string quoted double html"><span class="punctuation definition string begin html">&quot;</span>post<span class="punctuation definition string end html">&quot;</span></span>&nbsp;<span class="entity other attribute-name html">enctype</span>=<span class="string quoted double html"><span class="punctuation definition string begin html">&quot;</span>multipart/form-data<span class="punctuation definition string end html">&quot;</span></span><span class="punctuation definition tag end html">&gt;</span></span></span></div><div class="line"><span class="text html erb">&nbsp;&nbsp;<span class="meta tag inline any html"><span class="punctuation definition tag begin html">&lt;</span><span class="entity name tag inline any html">input</span>&nbsp;<span class="entity other attribute-name html">name</span>=<span class="string quoted double html"><span class="punctuation definition string begin html">&quot;</span>photo[image]<span class="punctuation definition string end html">&quot;</span></span>&nbsp;<span class="entity other attribute-name html">type</span>=<span class="string quoted double html"><span class="punctuation definition string begin html">&quot;</span>hidden<span class="punctuation definition string end html">&quot;</span></span>&nbsp;<span class="entity other attribute-name html">value</span>=<span class="string quoted double html"><span class="punctuation definition string begin html">&quot;</span><span class="meta embedded line erb"><span class="punctuation section embedded begin erb">&lt;%=</span><span class="source ruby">&nbsp;<span class="variable other readwrite instance ruby"><span class="punctuation definition variable ruby">@</span>photo</span><span class="punctuation separator method ruby">.</span>cached_image_data&nbsp;</span><span class="punctuation section embedded end erb"><span class="source ruby">%</span>&gt;</span></span><span class="punctuation definition string end html">&quot;</span></span><span class="punctuation definition tag end html">&nbsp;/&gt;</span></span></span></div><div class="line"><span class="text html erb">&nbsp;&nbsp;<span class="meta tag inline any html"><span class="punctuation definition tag begin html">&lt;</span><span class="entity name tag inline any html">input</span>&nbsp;<span class="entity other attribute-name html">name</span>=<span class="string quoted double html"><span class="punctuation definition string begin html">&quot;</span>photo[image]&nbsp;<span class="punctuation definition string end html">&quot;</span></span><span class="entity other attribute-name html">type</span>=<span class="string quoted double html"><span class="punctuation definition string begin html">&quot;</span>file<span class="punctuation definition string end html">&quot;</span></span><span class="punctuation definition tag end html">&nbsp;/&gt;</span></span></span></div><div class="line"><span class="text html erb">&nbsp;&nbsp;<span class="meta tag inline any html"><span class="punctuation definition tag begin html">&lt;</span><span class="entity name tag inline any html">input</span>&nbsp;<span class="entity other attribute-name html">type</span>=<span class="string quoted double html"><span class="punctuation definition string begin html">&quot;</span>submit<span class="punctuation definition string end html">&quot;</span></span>&nbsp;<span class="entity other attribute-name html">value</span>=<span class="string quoted double html"><span class="punctuation definition string begin html">&quot;</span>Create<span class="punctuation definition string end html">&quot;</span></span><span class="punctuation definition tag end html">&nbsp;/&gt;</span></span></span></div><div class="line"><span class="text html erb"><span class="meta tag block any html"><span class="punctuation definition tag begin html">&lt;/</span><span class="entity name tag block any html">form</span><span class="punctuation definition tag end html">&gt;</span></span></span></div></code></pre>
</span></div></div></div></div>
<p>Note that the file field needs to go <em>after</em> the hidden field, so that
selecting a new file can always override the cached file in the hidden field.
Also notice the <code>enctype=&quot;multipart/form-data&quot;</code> HTML attribute, which is
required for submitting files through the form (the Rails form builder
will automatically generate this for you).</p>
<p>When the form is submitted, in your router/controller you can assign the file
from request params to the attachment attribute on the model.</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-13-tab-14" class="nav-link active" data-group="group_13" data-tab="tab-group-13-content-14">Rails</div><div id="tab-group-13-tab-15" class="nav-link" data-group="group_13" data-tab="tab-group-13-content-15">Sinatra</div></div><div class="tab-content"><div id="tab-group-13-content-14" class="tab-pane active" data-group="group_13" tabindex="-1"><div><span><pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">PhotosController<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;ApplicationController</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method without-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">create</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="support class ruby">Photo</span><span class="punctuation separator method ruby">.</span>create<span class="punctuation section function ruby">(</span>photo_params<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">private</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method without-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">photo_params</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;params<span class="punctuation separator method ruby">.</span><span class="meta require ruby"><span class="keyword other special-method ruby">require</span><span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>photo</span><span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>permit<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation section function ruby">)</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
</span></div></div><div id="tab-group-13-content-15" class="tab-pane" data-group="group_13" tabindex="-1"><div><span><pre><code class="language-rb"><div class="line"><span class="source ruby">post&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>/photos<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">Photo</span><span class="punctuation separator method ruby">.</span>create<span class="punctuation section function ruby">(</span>params<span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>photo</span><span class="punctuation section array end ruby">]</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
</span></div></div></div></div>
<p>Once a file is uploaded and attached to the record, you can retrieve a URL to
the uploaded file with <code>#&lt;attachment&gt;_url</code> and display it on the page:</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-16-tab-17" class="nav-link active" data-group="group_16" data-tab="tab-group-16-content-17">Rails</div><div id="tab-group-16-tab-18" class="nav-link" data-group="group_16" data-tab="tab-group-16-content-18">HTML</div></div><div class="tab-content"><div id="tab-group-16-content-17" class="tab-pane active" data-group="group_16" tabindex="-1"><div><span><pre><code class="language-erb"><div class="line"><span class="text html erb"><span class="meta embedded line erb"><span class="punctuation section embedded begin erb">&lt;%=</span><span class="source ruby">&nbsp;image_tag&nbsp;<span class="variable other readwrite instance ruby"><span class="punctuation definition variable ruby">@</span>photo</span><span class="punctuation separator method ruby">.</span>image_url&nbsp;</span><span class="punctuation section embedded end erb"><span class="source ruby">%</span>&gt;</span></span></span></div></code></pre>
</span></div></div><div id="tab-group-16-content-18" class="tab-pane" data-group="group_16" tabindex="-1"><div><span><pre><code class="language-erb"><div class="line"><span class="text html erb"><span class="meta tag inline any html"><span class="punctuation definition tag begin html">&lt;</span><span class="entity name tag inline any html">img</span>&nbsp;<span class="entity other attribute-name html">src</span>=<span class="string quoted double html"><span class="punctuation definition string begin html">&quot;</span><span class="meta embedded line erb"><span class="punctuation section embedded begin erb">&lt;%=</span><span class="source ruby">&nbsp;<span class="variable other readwrite instance ruby"><span class="punctuation definition variable ruby">@</span>photo</span><span class="punctuation separator method ruby">.</span>image_url&nbsp;</span><span class="punctuation section embedded end erb"><span class="source ruby">%</span>&gt;</span></span><span class="punctuation definition string end html">&quot;</span></span><span class="punctuation definition tag end html">&nbsp;/&gt;</span></span></span></div></code></pre>
</span></div></div></div></div>
<h2><a class="anchor" aria-hidden="true" id="storage"></a><a href="#storage" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Storage</h2>
<p>A &quot;storage&quot; in Shrine is an object that encapsulates communication with a
specific storage service, by implementing a common public interface. Storage
instances are registered under an identifier in <code>Shrine.storages</code>, so that they
can later be used by <a href="#uploader">uploaders</a>.</p>
<p>Shrine ships with the following storages:</p>
<ul>
<li><a href="https://shrinerb.com/docs/storage/file-system"><code>Shrine::Storage::FileSystem</code></a> – stores files on disk</li>
<li><a href="https://shrinerb.com/docs/storage/s3"><code>Shrine::Storage::S3</code></a> – stores files on <a href="https://aws.amazon.com/s3/">AWS S3</a> (or <a href="https://www.digitalocean.com/products/spaces/">DigitalOcean Spaces</a>, <a href="https://min.io/">MinIO</a>, ...)</li>
<li><a href="https://shrinerb.com/docs/storage/memory"><code>Shrine::Storage::Memory</code></a> – stores file in memory (convenient for <a href="https://shrinerb.com/docs/testing">testing</a>)</li>
</ul>
<p>Here is how we might configure Shrine with S3 storage:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;Gemfile&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>aws-sdk-s3<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>~&gt;&nbsp;1.14<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;for&nbsp;AWS&nbsp;S3&nbsp;storage&nbsp;</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>shrine/storage/s3<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">s3_options&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">bucket<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>&lt;YOUR&nbsp;BUCKET&gt;<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;required&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">region<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>&lt;YOUR&nbsp;REGION&gt;<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;required&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">access_key_id<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>&lt;YOUR&nbsp;ACCESS&nbsp;KEY&nbsp;ID&gt;<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">secret_access_key<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>&lt;YOUR&nbsp;SECRET&nbsp;ACCESS&nbsp;KEY&gt;<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>storages&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">cache<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Storage</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">S3</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">prefix<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>cache<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="keyword operator arithmetic ruby">**</span>s3_options<span class="punctuation section function ruby">)</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;temporary&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">store<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Storage</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">S3</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="keyword operator arithmetic ruby">**</span>s3_options<span class="punctuation section function ruby">)</span><span class="punctuation separator object ruby">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;permanent&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section scope end ruby">}</span></span></div></code></pre>
<p>The above example sets up S3 for both temporary and permanent storage, which is
suitable for <a href="#presigned-direct-upload">direct uploads</a>. The <code>:cache</code> and <code>:store</code>
names are special only in terms that the <a href="#attacher">attacher</a> will automatically pick
them up, you can also register more storage objects under different names.</p>
<p>See the <a href="https://shrinerb.com/docs/storage/file-system">FileSystem</a>/<a href="https://shrinerb.com/docs/storage/s3">S3</a>/<a href="https://shrinerb.com/docs/storage/memory">Memory</a> storage docs for more details. There are
<a href="https://shrinerb.com/docs/external/extensions#storages">many more Shrine storages</a> provided by external gems, and you can
also <a href="https://shrinerb.com/docs/creating-storages">create your own storage</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="uploader"></a><a href="#uploader" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Uploader</h2>
<p>Uploaders are subclasses of <code>Shrine</code>, and they wrap the actual upload to the
storage. They perform common tasks around upload that aren't related to a
particular storage.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">MyUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;image&nbsp;attachment&nbsp;logic&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>It's common to create an uploader for each type of file that you want to handle
(<code>ImageUploader</code>, <code>VideoUploader</code>, <code>AudioUploader</code> etc), but really you can
organize them in any way you like.</p>
<h3><a class="anchor" aria-hidden="true" id="uploading"></a><a href="#uploading" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Uploading</h3>
<p>The main method of the uploader is <code>Shrine.upload</code>, which takes an <a href="#io-abstraction">IO-like
object</a> and a storage identifier on the input, and returns a
representation of the <a href="#uploaded-file">uploaded file</a> on the output.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">MyUploader</span><span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>file<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>store</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&gt;&nbsp;</span></span></div></code></pre>
<p>Internally this instantiates the uploader with the storage and calls
<code>Shrine#upload</code>:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploader&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">MyUploader</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>store</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">uploader<span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>file<span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&gt;&nbsp;</span></span></div></code></pre>
<p>Some of the tasks performed by <code>#upload</code> include:</p>
<ul>
<li>extracting <a href="#metadata">metadata</a></li>
<li>generating <a href="#location">location</a></li>
<li>uploading (this is where the <a href="#storage">storage</a> is called)</li>
<li>closing the uploaded file</li>
</ul>
<p>The second argument is a &quot;context&quot; hash which is forwarded to places like
metadata extraction and location generation, but it has a few special options:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploader<span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>io<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">metadata<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>foo<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>bar<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;add&nbsp;metadata&nbsp;</span></span></div><div class="line"><span class="source ruby">uploader<span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>io<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">location<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>path/to/file<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;specify&nbsp;custom&nbsp;location&nbsp;</span></span></div><div class="line"><span class="source ruby">uploader<span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>io<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">upload_options<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="constant other symbol hashkey ruby">acl<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>public-read<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;add&nbsp;options&nbsp;to&nbsp;Storage#upload&nbsp;</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="io-abstraction"></a><a href="#io-abstraction" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IO abstraction</h3>
<p>Shrine is able to upload any IO-like object that implement methods <a href="https://ruby-doc.org/core/IO.html#method-i-read"><code>#read</code></a>,
<a href="https://ruby-doc.org/core/IO.html#method-i-rewind"><code>#rewind</code></a>, <a href="https://ruby-doc.org/core/IO.html#method-i-eof"><code>#eof?</code></a> and <a href="https://ruby-doc.org/core/IO.html#method-i-close"><code>#close</code></a> whose behaviour matches the <a href="https://ruby-doc.org/core/IO.html"><code>IO</code></a> class.
This includes but is not limited to the following objects:</p>
<ul>
<li><a href="https://ruby-doc.org/core/File.html"><code>File</code></a></li>
<li><a href="https://ruby-doc.org/stdlib/libdoc/tempfile/rdoc/Tempfile.html"><code>Tempfile</code></a></li>
<li><a href="https://ruby-doc.org/stdlib/libdoc/stringio/rdoc/StringIO.html"><code>StringIO</code></a></li>
<li><a href="https://api.rubyonrails.org/classes/ActionDispatch/Http/UploadedFile.html"><code>ActionDispatch::Http::UploadedFile</code></a></li>
<li><a href="https://shrinerb.com/docs/plugins/rack_file"><code>Shrine::RackFile</code></a></li>
<li><a href="https://shrinerb.com/docs/plugins/data_uri"><code>Shrine::DataFile</code></a></li>
<li><a href="#uploaded-file"><code>Shrine::UploadedFile</code></a></li>
<li><a href="https://github.com/janko/down#streaming"><code>Down::ChunkedIO</code></a></li>
<li>...</li>
</ul>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploader<span class="punctuation separator method ruby">.</span>upload&nbsp;<span class="support class ruby">File</span><span class="punctuation separator method ruby">.</span><span class="support function kernel ruby">open</span><span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>/path/to/file<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">binmode<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;upload&nbsp;from&nbsp;disk&nbsp;</span></span></div><div class="line"><span class="source ruby">uploader<span class="punctuation separator method ruby">.</span>upload&nbsp;<span class="support class ruby">StringIO</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>file&nbsp;content<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;upload&nbsp;from&nbsp;memory&nbsp;</span></span></div><div class="line"><span class="source ruby">uploader<span class="punctuation separator method ruby">.</span>upload&nbsp;<span class="support class ruby">ActionDispatch</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Http</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">UploadedFile</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="punctuation separator method ruby">...</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;upload&nbsp;from&nbsp;Rails&nbsp;controller&nbsp;</span></span></div><div class="line"><span class="source ruby">uploader<span class="punctuation separator method ruby">.</span>upload&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>rack_file<span class="punctuation section function ruby">(</span><span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="constant other symbol hashkey ruby">tempfile<span class="punctuation definition constant ruby">:</span></span>&nbsp;tempfile&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;upload&nbsp;from&nbsp;Rack&nbsp;controller&nbsp;</span></span></div><div class="line"><span class="source ruby">uploader<span class="punctuation separator method ruby">.</span>upload&nbsp;<span class="support class ruby">Rack</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Test</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">UploadedFile</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="punctuation separator method ruby">...</span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;upload&nbsp;from&nbsp;rack-test&nbsp;</span></span></div><div class="line"><span class="source ruby">uploader<span class="punctuation separator method ruby">.</span>upload&nbsp;<span class="support class ruby">Down</span><span class="punctuation separator method ruby">.</span><span class="support function kernel ruby">open</span><span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span><span class="markup underline link https hyperlink">https://example.org/file</span><span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;upload&nbsp;from&nbsp;internet&nbsp;</span></span></div><div class="line"><span class="source ruby">uploader<span class="punctuation separator method ruby">.</span>upload&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">UploadedFile</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="punctuation separator method ruby">...</span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;upload&nbsp;from&nbsp;Shrine&nbsp;storage&nbsp;</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="uploaded-file"></a><a href="#uploaded-file" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Uploaded file</h2>
<p>The <code>Shrine::UploadedFile</code> object represents the file that was uploaded to a
storage, and it's what's returned from <code>Shrine#upload</code> or when retrieving a
record <a href="#attaching">attachment</a>.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploader<span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>file<span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&nbsp;...&gt;&nbsp;&nbsp;(uploader)&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&nbsp;...&gt;&nbsp;&nbsp;(attachment)&nbsp;</span></span></div><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>file&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&nbsp;...&gt;&nbsp;&nbsp;(attacher)&nbsp;</span></span></div></code></pre>
<p>An uploaded file object contains the following data:</p>
<table>
<thead>
<tr><th style="text-align:left">Key</th><th style="text-align:left">Description</th></tr>
</thead>
<tbody>
<tr><td style="text-align:left"><code>id</code></td><td style="text-align:left">location of the file on the storage</td></tr>
<tr><td style="text-align:left"><code>storage</code></td><td style="text-align:left">identifier of the storage the file was uploaded to</td></tr>
<tr><td style="text-align:left"><code>metadata</code></td><td style="text-align:left">file <a href="#metadata">metadata</a> that was extracted before upload</td></tr>
</tbody>
</table>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&nbsp;id=&quot;949sdjg834.jpg&quot;&nbsp;storage=:store&nbsp;metadata={...}&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;949sdjg834.jpg&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>storage_key&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;:store&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>storage&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::Storage::S3&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>metadata&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;{...}&nbsp;</span></span></div></code></pre>
<p>It comes with many convenient methods that delegate to the storage:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>url&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;<span class="markup underline link https hyperlink">https://my-bucket.s3.amazonaws.com/949sdjg834.jpg</span>&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span><span class="support function kernel ruby">open</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">io</span><span class="punctuation separator variable ruby">|</span>&nbsp;<span class="punctuation separator method ruby">...</span>&nbsp;<span class="punctuation section scope end ruby">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;opens&nbsp;the&nbsp;uploaded&nbsp;file&nbsp;stream&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>download&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">file</span><span class="punctuation separator variable ruby">|</span>&nbsp;<span class="punctuation separator method ruby">...</span>&nbsp;<span class="punctuation section scope end ruby">}</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;downloads&nbsp;the&nbsp;uploaded&nbsp;file&nbsp;to&nbsp;disk&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>stream<span class="punctuation section function ruby">(</span>destination<span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;streams&nbsp;uploaded&nbsp;content&nbsp;into&nbsp;a&nbsp;writable&nbsp;destination&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>exists?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;true&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>delete&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;deletes&nbsp;the&nbsp;uploaded&nbsp;file&nbsp;from&nbsp;the&nbsp;storage&nbsp;</span></span></div></code></pre>
<p>It also implements the IO-like interface that conforms to Shrine's <a href="#io-abstraction">IO
abstraction</a>, which allows it to be uploaded again to other
storages.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>read&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;returns&nbsp;content&nbsp;of&nbsp;the&nbsp;uploaded&nbsp;file&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>eof?&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;returns&nbsp;true&nbsp;if&nbsp;the&nbsp;whole&nbsp;IO&nbsp;was&nbsp;read&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>rewind&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;rewinds&nbsp;the&nbsp;IO&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>close&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;closes&nbsp;the&nbsp;IO&nbsp;</span></span></div></code></pre>
<p>For more details, see the <a href="https://shrinerb.com/docs/retrieving-uploads">Retrieving Uploads</a> guide and
<a href="https://shrinerb.com/rdoc/classes/Shrine/UploadedFile/InstanceMethods.html"><code>Shrine::UploadedFile</code></a> API docs.</p>
<h2><a class="anchor" aria-hidden="true" id="attaching"></a><a href="#attaching" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Attaching</h2>
<p>To attach uploaded files to database records, Shrine offers an attachment
interface built on top of uploaders and uploaded files. There are integrations
for various persistence libraries (<a href="https://shrinerb.com/docs/plugins/activerecord">ActiveRecord</a>,
<a href="https://shrinerb.com/docs/plugins/sequel">Sequel</a>, <a href="https://github.com/shrinerb/shrine-rom">ROM</a>, <a href="https://github.com/katafrakt/hanami-shrine">Hanami</a>,
<a href="https://github.com/shrinerb/shrine-mongoid">Mongoid</a>), but you can also attach files to plain structs
(<a href="https://shrinerb.com/docs/plugins/model">mutable</a> or <a href="https://shrinerb.com/docs/plugins/entity">immutable</a>).</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>sequel</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;:activerecord&nbsp;</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="attachment-module"></a><a href="#attachment-module" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Attachment module</h3>
<p>The easiest way to attach files is with the <code>Shrine::Attachment</code> module:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">Photo<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Sequel::Model</span></span></span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;ActiveRecord::Base&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">include</span>&nbsp;<span class="support class ruby">ImageUploader</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Attachment</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">include</span>&nbsp;<span class="support class ruby">ImageUploader</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Attachment</span><span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation section array end ruby">]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;use&nbsp;your&nbsp;preferred&nbsp;syntax&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">include</span>&nbsp;<span class="support class ruby">ImageUploader</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Attachment</span><span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>The included module will add attachment methods for the specified attribute:</p>
<table>
<thead>
<tr><th style="text-align:left">Method</th><th style="text-align:left">Description</th></tr>
</thead>
<tbody>
<tr><td style="text-align:left"><code>#image=</code></td><td style="text-align:left">uploads the file to temporary storage and serializes the result into <code>image_data</code></td></tr>
<tr><td style="text-align:left"><code>#image</code></td><td style="text-align:left">returns <a href="#uploaded-file"><code>Shrine::UploadedFile</code></a> instantiated from <code>image_data</code></td></tr>
<tr><td style="text-align:left"><code>#image_url</code></td><td style="text-align:left">calls <code>url</code> on the attachment if it's present, otherwise returns nil</td></tr>
<tr><td style="text-align:left"><code>#image_attacher</code></td><td style="text-align:left">returns instance of <a href="#attacher"><code>Shrine::Attacher</code></a> which handles the attaching</td></tr>
</tbody>
</table>
<p>The persistence plugin we loaded will add callbacks that ensure cached files
are automatically promoted to permanent storage on when record is saved, and
that attachments are deleted when the record is destroyed.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;no&nbsp;file&nbsp;is&nbsp;attached&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;nil&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;the&nbsp;assigned&nbsp;file&nbsp;is&nbsp;cached&nbsp;to&nbsp;temporary&nbsp;storage&nbsp;and&nbsp;written&nbsp;to&nbsp;`image_data`&nbsp;column&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">File</span><span class="punctuation separator method ruby">.</span><span class="support function kernel ruby">open</span><span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>waterfall.jpg<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>rb<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&nbsp;...&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image_url&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;/uploads/cache/0sdfllasfi842.jpg&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image_data&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&#39;{&quot;id&quot;:&quot;0sdfllasfi842.jpg&quot;,&quot;storage&quot;:&quot;cache&quot;,&quot;metadata&quot;:{...}}&#39;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;the&nbsp;cached&nbsp;file&nbsp;is&nbsp;promoted&nbsp;to&nbsp;permanent&nbsp;storage&nbsp;and&nbsp;saved&nbsp;to&nbsp;`image_data`&nbsp;column&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>save</span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&nbsp;...&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image_url&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;/uploads/store/l02kladf8jlda.jpg&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image_data&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&#39;{&quot;id&quot;:&quot;l02kladf8jlda.jpg&quot;,&quot;storage&quot;:&quot;store&quot;,&quot;metadata&quot;:{...}}&#39;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;the&nbsp;attached&nbsp;file&nbsp;is&nbsp;deleted&nbsp;with&nbsp;the&nbsp;record&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>destroy</span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation separator method ruby">.</span>exists?&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;false&nbsp;</span></span></div></code></pre>
<p>If there is already a file attached and a new file is attached, the previous
attachment will get deleted when the record gets saved.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>update<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">image<span class="punctuation definition constant ruby">:</span></span>&nbsp;new_file<span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;changes&nbsp;the&nbsp;attachment&nbsp;and&nbsp;deletes&nbsp;previous&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>update<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">image<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language nil ruby">nil</span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;removes&nbsp;the&nbsp;attachment&nbsp;and&nbsp;deletes&nbsp;previous&nbsp;</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="attacher"></a><a href="#attacher" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Attacher</h3>
<p>The methods and callbacks added by the <code>Shrine::Attachment</code> module just
delegate the behaviour to an underlying <code>Shrine::Attacher</code> object.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image_attacher&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::Attacher&gt;&nbsp;</span></span></div></code></pre>
<p>The <code>Shrine::Attacher</code> object can be instantiated and used directly:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">attacher&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">ImageUploader</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>from_model<span class="punctuation section function ruby">(</span>photo<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>image</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>assign<span class="punctuation section function ruby">(</span>file<span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;equivalent&nbsp;to&nbsp;`photo.image&nbsp;=&nbsp;file`&nbsp;</span></span></div><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>file&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;equivalent&nbsp;to&nbsp;`photo.image`&nbsp;</span></span></div><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>url&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;equivalent&nbsp;to&nbsp;`photo.image_url`&nbsp;</span></span></div></code></pre>
<p>The attacher is what drives attaching files to model instances; you can use it
as a more explicit alternative to models' attachment interface, or when you
need something that's not available through the attachment methods.</p>
<p>See <a href="https://shrinerb.com/docs/attacher">Using Attacher</a> guide for more details.</p>
<h3><a class="anchor" aria-hidden="true" id="temporary-storage"></a><a href="#temporary-storage" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Temporary storage</h3>
<p>Shrine uses temporary storage to support <a href="#validation">file validation</a> and
<a href="#direct-uploads">direct uploads</a>. If you don't need these features, you can tell Shrine to
upload files directly to permanent storage:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>model</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">cache<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">false</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">File</span><span class="punctuation separator method ruby">.</span><span class="support function kernel ruby">open</span><span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>waterfall.jpg<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>rb<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation separator method ruby">.</span>storage_key&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;:store&nbsp;</span></span></div></code></pre>
<p>If you're using the attacher directly, you can just use <code>Attacher#attach</code>
instead of <code>Attacher#assign</code>:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>attach&nbsp;<span class="support class ruby">File</span><span class="punctuation separator method ruby">.</span><span class="support function kernel ruby">open</span><span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>waterfall.jpg<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>rb<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">attacher<span class="punctuation separator method ruby">.</span>file<span class="punctuation separator method ruby">.</span>storage_key&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;:store&nbsp;</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="plugin-system"></a><a href="#plugin-system" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Plugin system</h2>
<p>By default, Shrine comes with a small core which provides only the essential
functionality. All additional features are available via <a href="https://shrinerb.com/plugins">plugins</a>, which also
ship with Shrine. This way you can choose exactly what and how much Shrine does
for you, and you load the code only for features that you use.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>instrumentation</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;adds&nbsp;instrumentation&nbsp;</span></span></div></code></pre>
<p>Plugins add behaviour by extending Shrine core classes via module inclusion, and
many of them also accept configuration options. The plugin system respects
inheritance, so you can choose to load a plugin globally or per uploader.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">ImageUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>store_dimensions</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;extract&nbsp;image&nbsp;dimensions&nbsp;only&nbsp;for&nbsp;this&nbsp;uploader&nbsp;and&nbsp;its&nbsp;descendants&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>If you want to extend Shrine functionality with custom behaviour, you can also
<a href="https://shrinerb.com/docs/creating-plugins">create your own plugin</a>. There are also additional <a href="https://shrinerb.com/docs/external/extensions#plugins">external
plugins</a> created by others.</p>
<blockquote>
<p>NOTE: An uploader class will inherit a copy of current superclass' plugin
options at the time of subclassing. This means you should <em>not</em> load
additional plugins on a superclass after the subclass has already been
created, because new options will not get applied to the subclass, which
can result in errors.</p>
</blockquote>
<h2><a class="anchor" aria-hidden="true" id="metadata"></a><a href="#metadata" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Metadata</h2>
<p>Shrine automatically extracts some basic file metadata and saves them to the
<code>Shrine::UploadedFile</code>. You can access them through the <code>#metadata</code> hash or via
metadata methods:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>metadata&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;{&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;filename&quot;&nbsp;=&gt;&nbsp;&quot;matrix.mp4&quot;,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;mime_type&quot;&nbsp;=&gt;&nbsp;&quot;video/mp4&quot;,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;&quot;size&quot;&nbsp;=&gt;&nbsp;345993,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;}&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>original_filename&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;matrix.mp4&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>extension&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;mp4&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>mime_type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;video/mp4&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;345993&nbsp;</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="mime-type"></a><a href="#mime-type" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MIME type</h3>
<p>By default, <code>mime_type</code> metadata will be set from the <code>#content_type</code> attribute
of the uploaded file (if it exists), which is generally not secure and will
trigger a warning. You can load the <a href="https://shrinerb.com/docs/plugins/determine_mime_type"><code>determine_mime_type</code></a> plugin to have MIME type extracted from file <em>content</em> instead.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;Gemfile&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>marcel<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>~&gt;&nbsp;0.3<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>determine_mime_type</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">analyzer<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>marcel</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Photo</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">image<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="support class ruby">StringIO</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>&lt;?php&nbsp;...&nbsp;?&gt;<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">))</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation separator method ruby">.</span>mime_type&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;application/x-php&quot;&nbsp;</span></span></div></code></pre>
<h3><a class="anchor" aria-hidden="true" id="other-metadata"></a><a href="#other-metadata" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Other metadata</h3>
<p>In addition to basic metadata, you can also extract <a href="https://shrinerb.com/docs/plugins/store_dimensions">image
dimensions</a>, calculate <a href="https://shrinerb.com/docs/plugins/signature">signatures</a>,
and in general extract any <a href="https://shrinerb.com/docs/plugins/add_metadata">custom metadata</a>. Check out
the <a href="https://shrinerb.com/docs/metadata">Extracting Metadata</a> guide for more details.</p>
<h2><a class="anchor" aria-hidden="true" id="processing"></a><a href="#processing" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Processing</h2>
<p>Shrine allows you to process attached files both &quot;eagerly&quot; and &quot;on-the-fly&quot;.
For example, if your app is accepting image uploads, you can generate a
predefined set of thumbnails when the image is attached to a record, or you
can have thumbnails generated dynamically as they're needed.</p>
<p>For image processing, it's recommended to use the <strong><a href="https://github.com/janko/image_processing">ImageProcessing</a></strong> gem,
which is a high-level wrapper for processing with
<a href="https://github.com/janko/image_processing/blob/master/doc/minimagick.md#readme">MiniMagick</a> and <a href="https://github.com/janko/image_processing/blob/master/doc/vips.md#readme">libvips</a>.</p>
<pre><code class="hljs">$ brew install imagemagick vips
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="eager-processing"></a><a href="#eager-processing" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Eager processing</h3>
<p>We can use the <a href="https://shrinerb.com/docs/plugins/derivatives"><code>derivatives</code></a> plugin to generate a
pre-defined set of processed files (e.g. image thumbnails). We do this by
registering a derivatives processor block and then explicitly triggering
creation:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;Gemfile&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image_processing<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>~&gt;&nbsp;1.8<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivatives</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">create_on_promote<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image_processing/mini_magick<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">ImageUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>derivatives&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">original</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;magick&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">ImageProcessing</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">MiniMagick</span><span class="punctuation separator method ruby">.</span>source<span class="punctuation section function ruby">(</span>original<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">large<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;magick<span class="punctuation separator method ruby">.</span>resize_to_limit!<span class="punctuation section function ruby">(</span><span class="constant numeric ruby">800</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">800</span><span class="punctuation section function ruby">)</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">medium<span class="punctuation definition constant ruby">:</span></span>&nbsp;magick<span class="punctuation separator method ruby">.</span>resize_to_limit!<span class="punctuation section function ruby">(</span><span class="constant numeric ruby">500</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">500</span><span class="punctuation section function ruby">)</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">small<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;magick<span class="punctuation separator method ruby">.</span>resize_to_limit!<span class="punctuation section function ruby">(</span><span class="constant numeric ruby">300</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">300</span><span class="punctuation section function ruby">)</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Photo</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">image<span class="punctuation definition constant ruby">:</span></span>&nbsp;file<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>save&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;automatically&nbsp;creates&nbsp;derivatives&nbsp;on&nbsp;promotion&nbsp;</span></span></div></code></pre>
<p>You can then retrieve the URL of a processed derivative:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>large</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;<span class="markup underline link https hyperlink">https://s3.amazonaws.com/path/to/large.jpg</span>&quot;&nbsp;</span></span></div></code></pre>
<p>The derivatives data is stored in the <code>&lt;attachment&gt;_data</code> column, and you can
retrieve them as <a href="#uploaded-file"><code>Shrine::UploadedFile</code></a> objects:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>large</span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Shrine::UploadedFile&nbsp;id=&quot;path/to/large.jpg&quot;&nbsp;storage=:store&nbsp;metadata={...}&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>large</span><span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>url&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;<span class="markup underline link https hyperlink">https://s3.amazonaws.com/path/to/large.jpg</span>&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>large</span><span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;5825949&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>large</span><span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>mime_type&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;image/jpeg&quot;&nbsp;</span></span></div></code></pre>
<p>For more details, see the <a href="https://shrinerb.com/docs/processing">File Processing</a> guide and the
<a href="https://shrinerb.com/docs/plugins/derivatives"><code>derivatives</code></a> plugin documentation.</p>
<h3><a class="anchor" aria-hidden="true" id="on-the-fly-processing"></a><a href="#on-the-fly-processing" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>On-the-fly processing</h3>
<p>On-the-fly processing is provided by the
<a href="https://shrinerb.com/docs/plugins/derivation_endpoint"><code>derivation_endpoint</code></a> plugin. To set it up, we
configure the plugin with a secret key and a path prefix, <a href="https://github.com/shrinerb/shrine/wiki/Mounting-Endpoints">mount</a> its Rack app in our routes on the configured path prefix, and define
processing we want to perform:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;Gemfile&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image_processing<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>~&gt;&nbsp;1.8<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;config/initializers/rails.rb&nbsp;(Rails)&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">secret_key<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>&lt;YOUR_SECRET_KEY&gt;<span class="punctuation definition string end ruby">&quot;</span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image_processing/mini_magick<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">ImageUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>derivation_endpoint</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">prefix<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>derivations/image<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;matches&nbsp;mount&nbsp;point&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;derivation&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span>&nbsp;<span class="keyword control start-block ruby">do&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">file</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">width</span><span class="punctuation separator variable ruby">,</span>&nbsp;<span class="variable other block ruby">height</span><span class="punctuation separator variable ruby">|</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="support class ruby">ImageProcessing</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">MiniMagick</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>source<span class="punctuation section function ruby">(</span>file<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation separator method ruby">.</span>resize_to_limit!<span class="punctuation section function ruby">(</span>width<span class="punctuation separator method ruby">.</span>to_i<span class="punctuation separator object ruby">,</span>&nbsp;height<span class="punctuation separator method ruby">.</span>to_i<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;config/routes.rb&nbsp;(Rails)&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Rails</span><span class="punctuation separator method ruby">.</span>application<span class="punctuation separator method ruby">.</span>routes<span class="punctuation separator method ruby">.</span>draw&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;mount&nbsp;<span class="support class ruby">ImageUploader</span><span class="punctuation separator method ruby">.</span>derivation_endpoint&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>/derivations/image<span class="punctuation definition string end ruby">&quot;</span></span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>Now we can generate URLs from attached files that will perform the desired
processing:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image<span class="punctuation separator method ruby">.</span>derivation_url<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumbnail</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">600</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant numeric ruby">400</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;/derivations/image/thumbnail/600/400/eyJpZCI6ImZvbyIsInN0b3JhZ2UiOiJzdG9yZSJ9?signature=...&quot;&nbsp;</span></span></div></code></pre>
<p>The on-the-fly processing feature is highly customizable, see the
<a href="https://shrinerb.com/docs/plugins/derivation_endpoint"><code>derivation_endpoint</code></a> plugin documentation for
more details.</p>
<h2><a class="anchor" aria-hidden="true" id="validation"></a><a href="#validation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Validation</h2>
<p>The <a href="https://shrinerb.com/docs/plugins/validation"><code>validation</code></a> plugin allows performing validation for
attached files. For common validations, the
<a href="https://shrinerb.com/docs/plugins/validation_helpers"><code>validation_helpers</code></a> plugin provides useful
validators for built in metadata:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>validation_helpers</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">DocumentUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>validate&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;validate_max_size&nbsp;<span class="constant numeric ruby">5</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">1024</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">1024</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">message<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>is&nbsp;too&nbsp;large&nbsp;(max&nbsp;is&nbsp;5&nbsp;MB)<span class="punctuation definition string end ruby">&quot;</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;validate_mime_type&nbsp;<span class="string quoted other ruby"><span class="punctuation section array begin ruby">%w[</span>application/pdf<span class="punctuation section array end ruby">]</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby">user&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">User</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span></span></div><div class="line"><span class="source ruby">user<span class="punctuation separator method ruby">.</span>cv&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">File</span><span class="punctuation separator method ruby">.</span><span class="support function kernel ruby">open</span><span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>cv.pdf<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>rb<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">user<span class="punctuation separator method ruby">.</span>valid?&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;false&nbsp;</span></span></div><div class="line"><span class="source ruby">user<span class="punctuation separator method ruby">.</span>errors<span class="punctuation separator method ruby">.</span>to_hash&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;{:cv=&gt;[&quot;is&nbsp;too&nbsp;large&nbsp;(max&nbsp;is&nbsp;5&nbsp;MB)&quot;]}&nbsp;</span></span></div></code></pre>
<p>For more details, see the <a href="https://shrinerb.com/docs/validation">File Validation</a> guide and
<a href="https://shrinerb.com/docs/plugins/validation_helpers"><code>validation_helpers</code></a> plugin docs.</p>
<h2><a class="anchor" aria-hidden="true" id="location"></a><a href="#location" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Location</h2>
<p>Shrine automatically generates random locations before uploading files. By
default, the hierarchy is flat, meaning all files are stored in the root
directory of the storage.</p>
<pre><code class="hljs">024d9fe83bf4fafb.jpg
768a336bf54de219.jpg
adfaa363629f7fc5.png
...
</code></pre>
<p>The <a href="https://shrinerb.com/docs/plugins/pretty_location"><code>pretty_location</code></a> plugin provides a good default
hierarchy:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>pretty_location</span></span></div></code></pre>
<pre><code class="hljs">user/
  564/
    avatar/
      aa3e0cd715.jpg
      thumb-493g82jf23.jpg
photo/
  123/
    image/
      13f8a7bc18.png
      thumb-9be62da67e.png
...
</code></pre>
<p>But you can also override <code>Shrine#generate_location</code> with a custom
implementation, for example:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">ImageUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">generate_location</span><span class="punctuation definition parameters ruby">(</span><span class="variable parameter function ruby">io</span>,&nbsp;<span class="variable parameter function ruby">record</span><span class="punctuation separator other ruby">:</span>&nbsp;<span class="constant language nil ruby">nil</span>,&nbsp;<span class="variable parameter function ruby">derivative</span><span class="punctuation separator other ruby">:</span>&nbsp;<span class="constant language nil ruby">nil</span>,&nbsp;<span class="keyword operator arithmetic ruby">**</span><span class="punctuation definition parameters ruby">)</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword control pseudo-method ruby">return</span>&nbsp;<span class="keyword control pseudo-method ruby">super</span>&nbsp;<span class="keyword control ruby">unless</span>&nbsp;record</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;table&nbsp;&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;record<span class="punctuation separator method ruby">.</span>class<span class="punctuation separator method ruby">.</span>table_name</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;record<span class="punctuation separator method ruby">.</span>id</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;prefix&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;derivative&nbsp;<span class="keyword operator logical ruby">||</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>original<span class="punctuation definition string end ruby">&quot;</span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>uploads/<span class="meta embedded line ruby"><span class="punctuation section embedded begin ruby"><span class="source ruby">#{</span></span><span class="source ruby">table</span><span class="punctuation section embedded end ruby"><span class="source ruby">}</span></span></span>/<span class="meta embedded line ruby"><span class="punctuation section embedded begin ruby"><span class="source ruby">#{</span></span><span class="source ruby">id</span><span class="punctuation section embedded end ruby"><span class="source ruby">}</span></span></span>/<span class="meta embedded line ruby"><span class="punctuation section embedded begin ruby"><span class="source ruby">#{</span></span><span class="source ruby">prefix</span><span class="punctuation section embedded end ruby"><span class="source ruby">}</span></span></span>-<span class="meta embedded line ruby"><span class="punctuation section embedded begin ruby"><span class="source ruby">#{</span></span><span class="source ruby"><span class="keyword control pseudo-method ruby">super</span></span><span class="punctuation section embedded end ruby"><span class="source ruby">}</span></span></span><span class="punctuation definition string end ruby">&quot;</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="hljs">uploads/
  photos/
    123/
      original-afe929b8b4.jpg
      small-ad61f25883.jpg
      medium-41b75c42bb.jpg
      large-73e67abe50.jpg
...
</code></pre>
<blockquote>
<p>There should always be a random component in the location, so that the ORM
dirty tracking is detected properly.</p>
</blockquote>
<p>The <code>Shrine#generate_location</code> method contains a lot of useful context for the
upcoming upload:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">ImageUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">generate_location</span><span class="punctuation definition parameters ruby">(</span><span class="variable parameter function ruby">io</span>,&nbsp;<span class="variable parameter function ruby">record</span><span class="punctuation separator other ruby">:</span>&nbsp;<span class="constant language nil ruby">nil</span>,&nbsp;<span class="variable parameter function ruby">name</span><span class="punctuation separator other ruby">:</span>&nbsp;<span class="constant language nil ruby">nil</span>,&nbsp;<span class="variable parameter function ruby">derivative</span><span class="punctuation separator other ruby">:</span>&nbsp;<span class="constant language nil ruby">nil</span>,&nbsp;<span class="variable parameter function ruby">metadata</span><span class="punctuation separator other ruby">:</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="punctuation section scope end ruby">}</span>,&nbsp;<span class="keyword operator arithmetic ruby">**</span>options<span class="punctuation definition parameters ruby">)</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;storage_key&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;:cache,&nbsp;:store,&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;io&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;File&gt;,&nbsp;#&lt;Shrine::UploadedFile&gt;,&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;record&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Photo&gt;,&nbsp;#&lt;User&gt;,&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;:image,&nbsp;:avatar,&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;derivative&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;:small,&nbsp;:medium,&nbsp;:large,&nbsp;...&nbsp;(derivatives&nbsp;plugin)&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;{&nbsp;&quot;filename&quot;&nbsp;=&gt;&nbsp;&quot;nature.jpg&quot;,&nbsp;&quot;mime_type&quot;&nbsp;=&gt;&nbsp;&quot;image/jpeg&quot;,&nbsp;&quot;size&quot;&nbsp;=&gt;&nbsp;18573,&nbsp;...&nbsp;}&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;options&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;{&nbsp;...&nbsp;other&nbsp;uploader&nbsp;options&nbsp;...&nbsp;}&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="direct-uploads"></a><a href="#direct-uploads" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Direct uploads</h2>
<p>To improve the user experience, it's recommended to upload files asynchronously
as soon as the user selects them. The direct uploads would go to temporary
storage, just like in the synchronous flow. Then, instead of attaching a raw
file to your model, you assign the cached file JSON data.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;in&nbsp;the&nbsp;regular&nbsp;synchronous&nbsp;flow&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;file</span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;in&nbsp;the&nbsp;direct&nbsp;upload&nbsp;flow&nbsp;</span></span></div><div class="line"><span class="source ruby">photo<span class="punctuation separator method ruby">.</span>image&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="string quoted single ruby"><span class="punctuation definition string begin ruby">&#39;</span>{&quot;id&quot;:&quot;...&quot;,&quot;storage&quot;:&quot;cache&quot;,&quot;metadata&quot;:{...}}<span class="punctuation definition string end ruby">&#39;</span></span></span></div></code></pre>
<p>On the client side it's highly recommended to use <strong><a href="https://uppy.io">Uppy</a></strong>, a very flexible
modern JavaScript file upload library that happens to integrate nicely with
Shrine.</p>
<h3><a class="anchor" aria-hidden="true" id="simple-direct-upload"></a><a href="#simple-direct-upload" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Simple direct upload</h3>
<p>The simplest approach is to upload directly to an endpoint in your app, which
forwards uploads to the specified storage. The
<a href="https://shrinerb.com/docs/plugins/upload_endpoint"><code>upload_endpoint</code></a> Shrine plugin provides a
<a href="https://github.com/shrinerb/shrine/wiki/Mounting-Endpoints">mountable</a> Rack app that implements this endpoint:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>upload_endpoint</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;config/routes.rb&nbsp;(Rails)&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Rails</span><span class="punctuation separator method ruby">.</span>application<span class="punctuation separator method ruby">.</span>routes<span class="punctuation separator method ruby">.</span>draw&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;mount&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>upload_endpoint<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>cache</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>/upload<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;POST&nbsp;/upload&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>Then you can configure Uppy's <a href="https://uppy.io/docs/xhr-upload/">XHR Upload</a> plugin to upload to
this endpoint. See <a href="https://github.com/shrinerb/shrine/wiki/Adding-Direct-App-Uploads">this walkthrough</a> for adding
simple direct uploads from scratch, it includes a complete JavaScript example
(there is also the <a href="https://github.com/shrinerb/shrine/tree/master/demo">Roda</a> / <a href="https://github.com/erikdahlstrand/shrine-rails-example">Rails</a> demo app).</p>
<h3><a class="anchor" aria-hidden="true" id="presigned-direct-upload"></a><a href="#presigned-direct-upload" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Presigned direct upload</h3>
<p>For better performance, you can also upload files directly to your cloud
storage service (AWS S3, Google Cloud Storage etc). For this, your temporary
storage needs to be your cloud service:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>shrine/storage/s3<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>storages&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">cache<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Storage</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">S3</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">prefix<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>cache<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="keyword operator arithmetic ruby">**</span>s3_options<span class="punctuation section function ruby">)</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">store<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Storage</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">S3</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="keyword operator arithmetic ruby">**</span>s3_options<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section scope end ruby">}</span></span></div></code></pre>
<p>In this flow, the client needs to first fetch upload parameters from the
server, and then use these parameters for the upload to the cloud service.
The <a href="https://shrinerb.com/docs/plugins/presign_endpoint"><code>presign_endpoint</code></a> Shrine plugin provides a
<a href="https://github.com/shrinerb/shrine/wiki/Mounting-Endpoints">mountable</a> Rack app that generates upload parameters:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>presign_endpoint</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;config/routes.rb&nbsp;(Rails)&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Rails</span><span class="punctuation separator method ruby">.</span>application<span class="punctuation separator method ruby">.</span>routes<span class="punctuation separator method ruby">.</span>draw&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;mount&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>presign_endpoint<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>cache</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>/s3/params<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;GET&nbsp;/s3/params&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>Then you can configure Uppy's <a href="https://uppy.io/docs/aws-s3/">AWS S3</a> plugin to fetch params from
your endpoint before uploading to S3. See <a href="https://github.com/shrinerb/shrine/wiki/Adding-Direct-S3-Uploads">this walkthrough</a> for adding direct uploads to S3 from scratch, it includes a complete
JavaScript example (there is also the <a href="https://github.com/shrinerb/shrine/tree/master/demo">Roda</a> / <a href="https://github.com/erikdahlstrand/shrine-rails-example">Rails</a>
demo). See also the <a href="https://shrinerb.com/docs/direct-s3">Direct Uploads to S3</a> guide for more details.</p>
<h3><a class="anchor" aria-hidden="true" id="resumable-direct-upload"></a><a href="#resumable-direct-upload" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Resumable direct upload</h3>
<p>If your app is accepting large uploads, you can improve resilience by making
the uploads <strong>resumable</strong>. This can significantly improve experience for users
on slow and flaky internet connections.</p>
<h4><a class="anchor" aria-hidden="true" id="uppy-s3-multipart"></a><a href="#uppy-s3-multipart" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Uppy S3 Multipart</h4>
<p>You can achieve resumable uploads directly to S3 with the <a href="https://uppy.io/docs/aws-s3-multipart/">AWS S3
Multipart</a> Uppy plugin, accompanied with
<code>uppy_s3_multipart</code> Shrine plugin provided by the <a href="https://github.com/janko/uppy-s3_multipart">uppy-s3_multipart</a> gem.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;Gemfile&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>uppy-s3_multipart<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>~&gt;&nbsp;0.3<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>uppy_s3_multipart</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;config/routes.rb&nbsp;(Rails)&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Rails</span><span class="punctuation separator method ruby">.</span>application<span class="punctuation separator method ruby">.</span>routes<span class="punctuation separator method ruby">.</span>draw&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;mount&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>uppy_s3_multipart<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>cache</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>/s3/multipart<span class="punctuation definition string end ruby">&quot;</span></span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>See the <a href="https://github.com/janko/uppy-s3_multipart">uppy-s3_multipart</a> docs for more details.</p>
<h4><a class="anchor" aria-hidden="true" id="tus-protocol"></a><a href="#tus-protocol" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tus protocol</h4>
<p>If you want a more generic approach, you can build your resumable uploads on
<strong><a href="https://tus.io">tus</a></strong> – an open resumable upload protocol. On the server side you can use
the <a href="https://github.com/janko/tus-ruby-server">tus-ruby-server</a> gem, on the client side Uppy's <a href="https://uppy.io/docs/tus/">Tus</a> plugin,
and the <a href="https://github.com/shrinerb/shrine-tus">shrine-tus</a> gem for the glue.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;Gemfile&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>tus-server<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>~&gt;&nbsp;2.0<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>shrine-tus<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>~&gt;&nbsp;2.1<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>shrine/storage/tus<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>storages&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">cache<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Storage</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Tus</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;tus&nbsp;server&nbsp;acts&nbsp;as&nbsp;temporary&nbsp;storage&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">store<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation separator method ruby">...</span><span class="punctuation separator object ruby">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;your&nbsp;permanent&nbsp;storage&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section scope end ruby">}</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;config/routes.rb&nbsp;(Rails)&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Rails</span><span class="punctuation separator method ruby">.</span>application<span class="punctuation separator method ruby">.</span>routes<span class="punctuation separator method ruby">.</span>draw&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;mount&nbsp;<span class="support class ruby">Tus</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Server</span>&nbsp;<span class="punctuation separator key-value">=&gt;</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>/files<span class="punctuation definition string end ruby">&quot;</span></span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>See <a href="https://github.com/shrinerb/shrine/wiki/Adding-Resumable-Uploads">this walkthrough</a> for adding tus-powered
resumable uploads from scratch, it includes a complete JavaScript example
(there is also a <a href="https://github.com/shrinerb/shrine-tus-demo">demo app</a>). See also <a href="https://github.com/shrinerb/shrine-tus">shrine-tus</a> and
<a href="https://github.com/janko/tus-ruby-server">tus-ruby-server</a> docs for more details.</p>
<h2><a class="anchor" aria-hidden="true" id="backgrounding"></a><a href="#backgrounding" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Backgrounding</h2>
<p>The <a href="https://shrinerb.com/docs/plugins/backgrounding"><code>backgrounding</code></a> plugin allows you to move file promotion
and deletion into a background job, using the backgrounding library <a href="https://github.com/shrinerb/shrine/wiki/Backgrounding-Libraries">of your
choice</a>:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>backgrounding</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>promote_block&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">PromoteJob</span><span class="punctuation separator method ruby">.</span>perform_async<span class="punctuation section function ruby">(</span><span class="variable language self ruby">self</span><span class="punctuation separator method ruby">.</span>class<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span>&nbsp;record<span class="punctuation separator method ruby">.</span>class<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span>&nbsp;record<span class="punctuation separator method ruby">.</span>id<span class="punctuation separator object ruby">,</span>&nbsp;name<span class="punctuation separator object ruby">,</span>&nbsp;file_data<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Attacher</span><span class="punctuation separator method ruby">.</span>destroy_block&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="support class ruby">DestroyJob</span><span class="punctuation separator method ruby">.</span>perform_async<span class="punctuation section function ruby">(</span><span class="variable language self ruby">self</span><span class="punctuation separator method ruby">.</span>class<span class="punctuation separator method ruby">.</span>name<span class="punctuation separator object ruby">,</span>&nbsp;data<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">PromoteJob</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">include</span>&nbsp;<span class="support class ruby">Sidekiq</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Worker</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">perform</span><span class="punctuation definition parameters ruby">(</span><span class="variable parameter function ruby">attacher_class</span>,&nbsp;<span class="variable parameter function ruby">record_class</span>,&nbsp;<span class="variable parameter function ruby">record_id</span>,&nbsp;<span class="variable parameter function ruby">name</span>,&nbsp;<span class="variable parameter function ruby">file_data</span><span class="punctuation definition parameters ruby">)</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher_class&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>attacher_class<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;record&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>record_class<span class="punctuation section function ruby">)</span><span class="punctuation separator method ruby">.</span>find<span class="punctuation section function ruby">(</span>record_id<span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;if&nbsp;using&nbsp;Active&nbsp;Record&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher_class<span class="punctuation separator method ruby">.</span>retrieve<span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">model<span class="punctuation definition constant ruby">:</span></span>&nbsp;record<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">name<span class="punctuation definition constant ruby">:</span></span>&nbsp;name<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">file<span class="punctuation definition constant ruby">:</span></span>&nbsp;file_data<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>atomic_promote</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">rescue</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">AttachmentChanged</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="support class ruby">ActiveRecord</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">RecordNotFound</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;attachment&nbsp;has&nbsp;changed&nbsp;or&nbsp;the&nbsp;record&nbsp;has&nbsp;been&nbsp;deleted,&nbsp;nothing&nbsp;to&nbsp;do&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">DestroyJob</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword other special-method ruby">include</span>&nbsp;<span class="support class ruby">Sidekiq</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Worker</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="meta function method with-arguments ruby"><span class="keyword control def ruby">def</span>&nbsp;<span class="entity name function ruby">perform</span><span class="punctuation definition parameters ruby">(</span><span class="variable parameter function ruby">attacher_class</span>,&nbsp;<span class="variable parameter function ruby">data</span><span class="punctuation definition parameters ruby">)</span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher_class&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Object</span><span class="punctuation separator method ruby">.</span>const_get<span class="punctuation section function ruby">(</span>attacher_class<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;attacher_class<span class="punctuation separator method ruby">.</span>from_data<span class="punctuation section function ruby">(</span>data<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;attacher<span class="punctuation separator method ruby">.</span>destroy</span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="clearing-cache"></a><a href="#clearing-cache" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Clearing cache</h2>
<p>Shrine doesn't automatically delete files uploaded to temporary storage, instead
you should set up a separate recurring task that will automatically delete old
cached files.</p>
<p>Most Shrine storage classes come with a <code>#clear!</code> method, which you can call in
a recurring script. For FileSystem and S3 storage it would look like this:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;FileSystem&nbsp;storage&nbsp;</span></span></div><div class="line"><span class="source ruby">file_system&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>storages<span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>cache</span><span class="punctuation section array end ruby">]</span></span></div><div class="line"><span class="source ruby">file_system<span class="punctuation separator method ruby">.</span>clear!&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">path</span><span class="punctuation separator variable ruby">|</span>&nbsp;path<span class="punctuation separator method ruby">.</span>mtime&nbsp;<span class="keyword operator comparison ruby">&lt;</span>&nbsp;<span class="support class ruby">Time</span><span class="punctuation separator method ruby">.</span>now&nbsp;<span class="keyword operator arithmetic ruby">-</span>&nbsp;<span class="constant numeric ruby">7</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">24</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">60</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">60</span>&nbsp;<span class="punctuation section scope end ruby">}</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;delete&nbsp;files&nbsp;older&nbsp;than&nbsp;1&nbsp;week&nbsp;</span></span></div></code></pre>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;S3&nbsp;storage&nbsp;</span></span></div><div class="line"><span class="source ruby">s3&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>storages<span class="punctuation section array begin ruby">[</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>cache</span><span class="punctuation section array end ruby">]</span></span></div><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>clear!&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">object</span><span class="punctuation separator variable ruby">|</span>&nbsp;object<span class="punctuation separator method ruby">.</span>last_modified&nbsp;<span class="keyword operator comparison ruby">&lt;</span>&nbsp;<span class="support class ruby">Time</span><span class="punctuation separator method ruby">.</span>now&nbsp;<span class="keyword operator arithmetic ruby">-</span>&nbsp;<span class="constant numeric ruby">7</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">24</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">60</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">60</span>&nbsp;<span class="punctuation section scope end ruby">}</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;delete&nbsp;files&nbsp;older&nbsp;than&nbsp;1&nbsp;week&nbsp;</span></span></div></code></pre>
<p>For S3, it may be easier and cheaper to use <a href="http://docs.aws.amazon.com/AmazonS3/latest/UG/lifecycle-configuration-bucket-no-versioning.html">S3 bucket lifecycle expiration rules</a>  instead.</p>
<h2><a class="anchor" aria-hidden="true" id="logging"></a><a href="#logging" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Logging</h2>
<p>The <a href="https://shrinerb.com/docs/plugins/instrumentation"><code>instrumentation</code></a> plugin sends and logs events for
important operations:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>instrumentation</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">notifications<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="support class ruby">ActiveSupport</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">Notifications</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">uploaded_file&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>io<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>store</span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>exists?</span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>download</span></div><div class="line"><span class="source ruby">uploaded_file<span class="punctuation separator method ruby">.</span>delete</span></div></code></pre>
<pre><code class="hljs">Metadata (32ms) – {:storage=>:store, :io=>StringIO, :uploader=>Shrine}
Upload (1523ms) – {:storage=>:store, :location=>"ed0e30ddec8b97813f2c1f4cfd1700b4", :io=>StringIO, :upload_options=>{}, :uploader=>Shrine}
Exists (755ms) – {:storage=>:store, :location=>"ed0e30ddec8b97813f2c1f4cfd1700b4", :uploader=>Shrine}
Download (1002ms) – {:storage=>:store, :location=>"ed0e30ddec8b97813f2c1f4cfd1700b4", :download_options=>{}, :uploader=>Shrine}
Delete (700ms) – {:storage=>:store, :location=>"ed0e30ddec8b97813f2c1f4cfd1700b4", :uploader=>Shrine}
</code></pre>
<p>Some plugins add their own instrumentation as well when they detect that the
<code>instrumentation</code> plugin has been loaded. For that to work, the
<code>instrumentation</code> plugin needs to be loaded <em>before</em> any of these plugins.</p>
<table>
<thead>
<tr><th style="text-align:left">Plugin</th><th style="text-align:left">Instrumentation</th></tr>
</thead>
<tbody>
<tr><td style="text-align:left"><code>derivation_endpoint</code></td><td style="text-align:left">instruments file processing</td></tr>
<tr><td style="text-align:left"><code>derivatives</code></td><td style="text-align:left">instruments file processing</td></tr>
<tr><td style="text-align:left"><code>determine_mime_type</code></td><td style="text-align:left">instruments analyzing MIME type</td></tr>
<tr><td style="text-align:left"><code>store_dimensions</code></td><td style="text-align:left">instruments extracting image dimensions</td></tr>
<tr><td style="text-align:left"><code>signature</code></td><td style="text-align:left">instruments calculating signature</td></tr>
<tr><td style="text-align:left"><code>infer_extension</code></td><td style="text-align:left">instruments inferring extension</td></tr>
<tr><td style="text-align:left"><code>remote_url</code></td><td style="text-align:left">instruments remote URL downloading</td></tr>
<tr><td style="text-align:left"><code>data_uri</code></td><td style="text-align:left">instruments data URI parsing</td></tr>
</tbody>
</table>
<p>For instrumentation, warnings, and other logging, Shrine uses its internal
logger. You can tell Shrine to use a different logger. For example, if you're
using Rails, you might want to tell it to use the Rails logger:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>logger&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Rails</span><span class="punctuation separator method ruby">.</span>logger</span></div></code></pre>
<p>In tests you might want to tell Shrine to log only warnings:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator method ruby">.</span>logger<span class="punctuation separator method ruby">.</span>level&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Logger</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">WARN</span></span></div></code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/advantages"><span class="arrow-prev">← </span><span>Advantages of Shrine</span></a><a class="docs-next button" href="/docs/design"><span>The Design of Shrine</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#quick-start">Quick start</a></li><li><a href="#storage">Storage</a></li><li><a href="#uploader">Uploader</a><ul class="toc-headings"><li><a href="#uploading">Uploading</a></li><li><a href="#io-abstraction">IO abstraction</a></li></ul></li><li><a href="#uploaded-file">Uploaded file</a></li><li><a href="#attaching">Attaching</a><ul class="toc-headings"><li><a href="#attachment-module">Attachment module</a></li><li><a href="#attacher">Attacher</a></li><li><a href="#temporary-storage">Temporary storage</a></li></ul></li><li><a href="#plugin-system">Plugin system</a></li><li><a href="#metadata">Metadata</a><ul class="toc-headings"><li><a href="#mime-type">MIME type</a></li><li><a href="#other-metadata">Other metadata</a></li></ul></li><li><a href="#processing">Processing</a><ul class="toc-headings"><li><a href="#eager-processing">Eager processing</a></li><li><a href="#on-the-fly-processing">On-the-fly processing</a></li></ul></li><li><a href="#validation">Validation</a></li><li><a href="#location">Location</a></li><li><a href="#direct-uploads">Direct uploads</a><ul class="toc-headings"><li><a href="#simple-direct-upload">Simple direct upload</a></li><li><a href="#presigned-direct-upload">Presigned direct upload</a></li><li><a href="#resumable-direct-upload">Resumable direct upload</a></li></ul></li><li><a href="#backgrounding">Backgrounding</a></li><li><a href="#clearing-cache">Clearing cache</a></li><li><a href="#logging">Logging</a></li></ul></nav></div><footer class="nav-footer" id="footer" data-version="3.4.0"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/logo.png" alt="Shrine" width="66"/></a><div><h5>Docs</h5><a href="/guides">Guides</a><a href="/plugins">Plugins</a><a href="/external">External</a><a href="https://github.com/shrinerb/shrine/blob/master/CONTRIBUTING.md#readme">Contributing</a></div><div><h5>Community</h5><a href="https://discourse.shrinerb.com" target="_blank" rel="noreferrer noopener">Discourse</a><a href="https://stackoverflow.com/questions/tagged/shrine" target="_blank" rel="noreferrer noopener">Stack Overflow</a></div><div><h5>More</h5><a href="https://twin.github.io">Blog</a><a href="https://github.com/shrinerb/shrine">GitHub</a><a class="github-button" href="https://github.com/shrinerb/shrine" data-icon="octicon-star" data-count-href="/shrinerb/shrine/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a><div class="social"><a href="https://twitter.com/shrine_rb" class="twitter-follow-button">Follow @shrine_rb</a></div></div></section><section class="copyright">Copyright © 2022 Janko Marohnić</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '09a11b10801874df7d226df4f2ce8e8f',
                indexName: 'shrinerb',
                inputSelector: '#search_input_react'
              });
            </script></body></html>